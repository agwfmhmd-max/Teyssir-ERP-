<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ERP System - MDA PRO</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135679.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3135/3135679.png">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            --primary: #1e3a8a; --secondary: #10b981; --danger: #ef4444; 
            --bg: #f4f7fa; --sidebar-w: 260px; --header-h: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: #333; overflow-x: hidden; }

        /* --- Language Button --- */
        .lang-float {
            position: fixed; top: 10px; z-index: 2000;
            background: white; border: 1px solid #ccc; padding: 5px 12px;
            border-radius: 20px; font-weight: bold; font-size: 14px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        html[dir="rtl"] .lang-float { left: 15px; } 
        html[dir="ltr"] .lang-float { right: 15px; }

        /* --- Auth Screen --- */
        .auth-wrap {
            display: flex; min-height: 100vh; justify-content: center; align-items: center;
            background: linear-gradient(135deg, #1e3a8a, #111827); padding: 20px;
        }
        .auth-card {
            background: white; width: 100%; max-width: 400px; padding: 30px 20px;
            border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .inp {
            width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px;
            font-size: 16px; margin-bottom: 15px; outline: none; transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,58,138,0.1); }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 10px;
            font-weight: bold; font-size: 14px; cursor: pointer; color: white; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-prim { background: var(--primary); }
        .btn-sec { background: var(--secondary); }
        .btn-dan { background: var(--danger); }

        .wa-link {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: #25D366; color: white; text-decoration: none; padding: 12px;
            border-radius: 50px; font-weight: bold; margin-top: 15px;
        }

        /* --- Install PWA Button --- */
        #installBtn { 
            display: none; width: 100%; background: #333; color: white; margin-bottom: 15px; 
            padding: 10px; border-radius: 8px; text-align: center; cursor: pointer;
        }

        /* --- Dashboard Layout --- */
        .app-container { display: none; flex-direction: column; min-height: 100vh; }

        .top-header {
            height: var(--header-h); background: white; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            position: sticky; top: 0; z-index: 1000;
        }
        .menu-btn { font-size: 24px; cursor: pointer; color: var(--primary); padding: 5px; }

        /* Sidebar Logic */
        .sidebar {
            position: fixed; top: 0; bottom: 0; width: 280px; background: white;
            z-index: 1500; padding-top: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        html[dir="rtl"] .sidebar { right: 0; transform: translateX(100%); }
        html[dir="rtl"] .sidebar.open { transform: translateX(0); }
        html[dir="ltr"] .sidebar { left: 0; transform: translateX(-100%); }
        html[dir="ltr"] .sidebar.open { transform: translateX(0); }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1400; display: none;
        }
        .sidebar-overlay.show { display: block; }

        .nav-item {
            padding: 15px 20px; display: flex; align-items: center; gap: 15px;
            color: #555; font-weight: 500; cursor: pointer; border-bottom: 1px solid #f9f9f9;
        }
        .nav-item.active { background: #eff6ff; color: var(--primary); }

        .main-content { flex: 1; padding: 15px; overflow-y: auto; }

        /* --- Responsive Grid --- */
        .grid-responsive { display: grid; gap: 15px; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }

        /* Desktop View */
        @media (min-width: 768px) {
            .grid-responsive { grid-template-columns: 1.5fr 1fr; } /* Products wider than Cart */
            .sidebar { 
                position: fixed; top: var(--header-h); bottom: 0; width: 250px; 
                transform: none !important; box-shadow: none; border-inline-end: 1px solid #eee; z-index: 900; 
            }
            html[dir="rtl"] .main-content { margin-right: 250px; }
            html[dir="ltr"] .main-content { margin-left: 250px; }
            .menu-btn, .sidebar-overlay { display: none !important; }
        }

        /* Mobile View for POS */
        @media (max-width: 767px) {
            .pos-container { grid-template-columns: 1fr; height: auto; }
        }

        /* --- Components --- */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }

        .table-scroll { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; /* Wider for admin table */ }
        th, td { padding: 12px; text-align: start; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f8f9fa; white-space: nowrap; font-weight: bold; color: var(--primary); }

        /* --- POS Elements --- */
        .pos-container { display: grid; gap: 20px; }
        @media(min-width: 768px) { .pos-container { height: calc(100vh - 90px); } }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; overflow-y: auto; max-height: 60vh; padding: 5px; }
        .prod-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 100px; }
        .prod-card:hover { border-color: var(--primary); background: #e3f2fd; }
        .prod-card h4 { margin: 0 0 5px 0; font-size: 13px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .prod-card .price { color: var(--primary); font-weight: bold; font-size: 15px; }
        .prod-card .stock { font-size: 11px; color: #666; }

        .pos-controls { display: flex; gap: 5px; background: #eee; padding: 10px; border-radius: 10px; margin-top: 10px; align-items: flex-end; }
        
        .selected-product-panel {
            background: #e3f2fd; border: 2px solid var(--primary); border-radius: 12px; padding: 15px; margin-top: 10px; display: none; animation: slideUp 0.2s ease;
        }
        @keyframes slideUp { from{transform:translateY(10px);opacity:0} to{transform:translateY(0);opacity:1} }
        
        .selected-info { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; font-weight: bold; }
        .action-row { display: flex; gap: 10px; }
        
        .big-qty-input { flex: 1; height: 50px; font-size: 22px; text-align: center; border: 2px solid #ccc; border-radius: 8px; font-weight: bold; }
        .big-qty-input:focus { border-color: var(--primary); outline: none; background: white; }
        
        .add-btn-large { flex: 2; height: 50px; background: var(--secondary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .add-btn-large:active { transform: scale(0.98); }

        .cart-items { max-height: 50vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f1f1; font-size: 14px; }

        /* --- Admin Status --- */
        #adminLink { display: none !important; }
        .status-active { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .status-suspended { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        .pay-history { font-size: 10px; color: #666; margin-top: 5px; max-height: 40px; overflow-y: auto; }
        
        /* Subscription Block */
        .block-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        .block-icon { font-size: 60px; margin-bottom: 20px; color: var(--danger); }
        .expiry-warning {
            background: #fff3cd; color: #856404; padding: 10px; text-align: center;
            font-size: 13px; font-weight: bold; border-bottom: 1px solid #ffeeba;
            display: none;
        }

        /* --- Print --- */
        .print-box { display: none; }
        @media print { 
            .app-container, .auth-wrap, .lang-float, #expiryWarning { display: none !important; } 
            .print-box { display: block !important; position: absolute; top:0; left:0; width:100%; background:white; } 
        }
    </style>
</head>
<body>

    <button onclick="app.toggleLang()" class="lang-float" id="langBtn">FranÃ§ais</button>

    <!-- Expiry Warning -->
    <div id="expiryWarning" class="expiry-warning"></div>

    <!-- Block Screen -->
    <div id="blockScreen" class="block-screen">
        <i class="fa-solid fa-lock block-icon"></i>
        <h2 id="blockTitle" style="color:var(--danger)">Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù„Ù‚</h2>
        <p id="blockMsg" style="margin-bottom:20px;">Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©.</p>
        <a href="https://wa.me/22220479962" class="wa-link" style="width:auto; padding:10px 30px;">
            <i class="fa-brands fa-whatsapp"></i> ØªÙˆØ§ØµÙ„ Ù„Ù„Ø¯ÙØ¹
        </a>
        <button onclick="app.logout()" class="btn btn-dan" style="margin-top:20px; width:auto;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- Auth -->
    <div id="authScreen" class="auth-wrap">
        <div class="auth-card">
            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135679.png" alt="Icon" style="width:60px; margin-bottom:10px;">
            <h2 style="color:var(--primary); margin-top:0;" id="t_title">ERP System</h2>
            <div id="installBtn" onclick="app.installPWA()">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ / Install</div>
            <form onsubmit="app.login(event)">
                <input id="logName" class="inp" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©" required>
                <input id="logPhone" type="tel" class="inp" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
                <input id="logCode" type="password" class="inp" placeholder="Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„" required>
                <button type="submit" id="logBtn" class="btn btn-prim">Ø¯Ø®ÙˆÙ„</button>
            </form>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <p style="margin:0 0 10px; color:#666; font-size:0.9em;" id="t_getcode">Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²:</p>
                <a href="https://wa.me/22220479962" class="wa-link"><i class="fa-brands fa-whatsapp"></i> <span id="t_contact">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±</span></a>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="appScreen" class="app-container">
        <div class="sidebar-overlay" onclick="app.toggleMenu()"></div>
        <header class="top-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="menu-btn" onclick="app.toggleMenu()"><i class="fa-solid fa-bars"></i></div>
                <div><div id="h_name" style="font-weight:bold;"></div><div id="h_phone" style="font-size:12px; color:#666;"></div></div>
            </div>
            <button onclick="app.logout()" class="btn btn-dan" style="width:auto; padding:8px 15px;" id="t_logout">Ø®Ø±ÙˆØ¬</button>
        </header>
        <aside class="sidebar" id="sidebar">
            <div style="padding: 0 20px 20px; text-align:center;">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135679.png" style="width:40px;">
                <h3 style="color:var(--primary); margin:10px 0 0;">ERP MENU</h3>
            </div>
            <div class="nav-item active" onclick="app.nav('home')"><i class="fa-solid fa-home"></i> <span data-key="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
            <div class="nav-item" onclick="app.nav('pos')"><i class="fa-solid fa-cart-plus"></i> <span data-key="pos">Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</span></div>
            <div class="nav-item" onclick="app.nav('invoices')"><i class="fa-solid fa-file-invoice"></i> <span data-key="inv">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span></div>
            <div class="nav-item" onclick="app.nav('inventory')"><i class="fa-solid fa-boxes"></i> <span data-key="stock">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></div>
            <div class="nav-item" onclick="app.nav('expenses')"><i class="fa-solid fa-wallet"></i> <span data-key="exp">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span></div>
            <div class="nav-item" onclick="app.nav('salaries')"><i class="fa-solid fa-users"></i> <span data-key="sal">Ø§Ù„Ø±ÙˆØ§ØªØ¨</span></div>
            <div class="nav-item" onclick="app.nav('reports')"><i class="fa-solid fa-chart-pie"></i> <span data-key="rep">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
            <div id="adminLink" class="nav-item hidden" onclick="app.nav('admin')" style="color:red;"><i class="fa-solid fa-lock"></i> Admin</div>
        </aside>
        <main id="workspace" class="main-content"></main>
    </div>

    <!-- Print -->
    <div id="printArea" class="print-box"></div>

    <script>
        let deferredPrompt;
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'block'; });

        const firebaseConfig = {
            apiKey: "AIzaSyA6glwj94Onm0r6gRtxtoyqEISpPChDcHo",
            authDomain: "comptabilite-e35ed.firebaseapp.com",
            projectId: "comptabilite-e35ed",
            storageBucket: "comptabilite-e35ed.firebasestorage.app",
            messagingSenderId: "59372022194",
            appId: "1:59372022194:web:22b9f70c41b1479835dcab",
            measurementId: "G-EEDNJXLSN6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let selectedProduct = null;

        const dict = {
            ar: {
                title: "Ù†Ø¸Ø§Ù… ERP - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©", comp:"Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©", phone:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", code:"Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„",
                btn:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", wait:"Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...", get:"Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„:", cont:"ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± (ÙˆØ§ØªØ³Ø§Ø¨)",
                home:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", pos:"Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹", inv:"Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙÙˆØ§ØªÙŠØ±", stock:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
                exp:"Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", sal:"Ø§Ù„Ø±ÙˆØ§ØªØ¨", rep:"Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©", logout:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
                p_sel:"Ø§Ø®ØªØ± Ù…Ù†ØªØ¬Ø§Ù‹ Ù„Ù„Ø¨ÙŠØ¹", p_pr:"Ø§Ù„Ø³Ø¹Ø±", p_qt:"Ø§Ù„Ø¹Ø¯Ø¯", p_add:"Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©",
                p_cl:"Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„", p_save:"Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø©", p_tot:"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
                tbl_prod:"Ø§Ù„Ù…Ù†ØªØ¬", tbl_qty:"Ø§Ù„ÙƒÙ…ÙŠØ©", tbl_tot:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹", tbl_act:"Ø­Ø°Ù",
                th_date:"Ø§Ù„ØªØ§Ø±ÙŠØ®", th_client:"Ø§Ù„Ø¹Ù…ÙŠÙ„", th_amount:"Ø§Ù„Ù…Ø¨Ù„Øº", th_print:"Ø·Ø¨Ø§Ø¹Ø©",
                th_name:"Ø§Ù„Ø§Ø³Ù…", th_buy:"Ø´Ø±Ø§Ø¡", th_sell:"Ø¨ÙŠØ¹", th_stock:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", th_del:"Ø­Ø°Ù", th_edit:"ØªØ¹Ø¯ÙŠÙ„",
                th_item:"Ø§Ù„Ø¨Ù†Ø¯", th_note:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª", th_cost:"Ø§Ù„ØªÙƒÙ„ÙØ©", th_emp:"Ø§Ù„Ù…ÙˆØ¸Ù", th_job:"Ø§Ù„ÙˆØ¸ÙŠÙØ©", th_sal:"Ø§Ù„Ø±Ø§ØªØ¨",
                income:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª", expense:"Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©", profit:"ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­", cogs:"ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©", unsold:"Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ",
                err_login:"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©", err_sus:"Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹",
                empty:"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©", max_qty:"Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·: ",
                prompt_name:"Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø¨ÙŠØ§Ù†", prompt_buy:"Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡", prompt_sell:"Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹", prompt_qty:"Ø§Ù„ÙƒÙ…ÙŠØ©",
                prompt_note:"Ù…Ù„Ø§Ø­Ø¸Ø©", prompt_amount:"Ø§Ù„Ù…Ø¨Ù„Øº", 
                confirm_del:"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ",
                sys_active:"Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­",
                err_price_logic: "Ø®Ø·Ø£: Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡",
                prompt_new_price: "Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯",
                
                // Admin & Subscription
                adm_time: "Ø§Ù„ØªØ§Ø±ÙŠØ®", adm_comp: "Ø§Ù„Ø´Ø±ÙƒØ©", adm_phone: "Ø§Ù„Ù‡Ø§ØªÙ", adm_code: "Ø§Ù„Ø±Ù…Ø²", adm_stat: "Ø§Ù„Ø­Ø§Ù„Ø©", adm_act: "Ø§Ù„ØªØ­ÙƒÙ…",
                adm_gen: "ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯", adm_renew: "ØªØ¬Ø¯ÙŠØ¯ ($)", adm_pay_hist: "Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª",
                msg_sus: "ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„Ù„Ø¯ÙØ¹.",
                msg_exp: "Ø§Ù†ØªÙ‡Øª ÙØªØ±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¯ÙØ¹ Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©.",
                msg_warn: "ØªØ­Ø°ÙŠØ±: Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹ (ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ù…ØªØ¨Ù‚ÙŠ). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.",
                sub_day: "ÙŠÙˆÙ…ÙŠ", sub_week: "Ø£Ø³Ø¨ÙˆØ¹ÙŠ", sub_month: "Ø´Ù‡Ø±ÙŠ", sub_year: "Ø³Ù†ÙˆÙŠ",
                adm_stop: "ØªØ¬Ù…ÙŠØ¯", adm_start: "ØªÙØ¹ÙŠÙ„", adm_del: "Ø­Ø°Ù"
            },
            fr: {
                title: "SystÃ¨me ERP - Ã‰dition Gold", comp:"Nom de SociÃ©tÃ©", phone:"TÃ©lÃ©phone", code:"Code d'activation",
                btn:"Connexion", wait:"VÃ©rification...", get:"Pour obtenir le code:", cont:"Contacter le dÃ©veloppeur",
                home:"Accueil", pos:"Point de Vente", inv:"Factures", stock:"Stock",
                exp:"DÃ©penses", sal:"Salaires", rep:"Rapports", logout:"DÃ©connexion",
                p_sel:"Choisir un produit", p_pr:"Prix", p_qt:"QtÃ©", p_add:"Ajouter",
                p_cl:"Nom du Client", p_save:"Enregistrer & Imprimer", p_tot:"Total",
                tbl_prod:"Produit", tbl_qty:"QtÃ©", tbl_tot:"Total", tbl_act:"Suppr",
                th_date:"Date", th_client:"Client", th_amount:"Montant", th_print:"Imprimer",
                th_name:"Nom", th_buy:"Achat", th_sell:"Vente", th_stock:"Stock", th_del:"Suppr", th_edit:"Modif",
                th_item:"Article", th_note:"Note", th_cost:"CoÃ»t", th_emp:"EmployÃ©", th_job:"Fonction", th_sal:"Salaire",
                income:"Revenus (Ventes)", expense:"DÃ©penses GÃ©nÃ©rales", profit:"BÃ©nÃ©fice Net", cogs:"CoÃ»t des Marchandises", unsold:"Valeur du Stock",
                err_login:"Identifiants invalides", err_sus:"Compte suspendu",
                empty:"Panier vide", max_qty:"Max disponible: ",
                prompt_name:"Nom / Article", prompt_buy:"Prix d'achat", prompt_sell:"Prix de vente", prompt_qty:"QuantitÃ©",
                prompt_note:"Note", prompt_amount:"Montant", 
                confirm_del:"Confirmer la suppression ?",
                sys_active:"SystÃ¨me Actif",
                err_price_logic: "Erreur: Le prix de vente doit Ãªtre supÃ©rieur au prix d'achat",
                prompt_new_price: "Entrez le nouveau prix de vente",
                
                // Admin & Subscription
                adm_time: "Date", adm_comp: "SociÃ©tÃ©", adm_phone: "TÃ©l", adm_code: "Code", adm_stat: "Statut", adm_act: "Action",
                adm_gen: "GÃ©nÃ©rer Code", adm_renew: "Renouveler ($)", adm_pay_hist: "Historique",
                msg_sus: "Compte suspendu par l'admin. Contactez pour payer.",
                msg_exp: "Abonnement expirÃ©. Veuillez payer pour renouveler.",
                msg_warn: "Attention: Votre abonnement expire bientÃ´t (1 jour).",
                sub_day: "Journalier", sub_week: "Hebdomadaire", sub_month: "Mensuel", sub_year: "Annuel",
                adm_stop: "Suspendre", adm_start: "Activer", adm_del: "Supprimer"
            }
        };

        const app = {
            state: { cid:null, name:'', phone:'', admin:false, lang:'ar', codeDocId: null },
            cart: [],

            init: function() {
                if (deferredPrompt) { deferredPrompt.prompt(); }
                const session = localStorage.getItem('mda_session');
                if (session) {
                    const s = JSON.parse(session);
                    this.verifySession(s);
                }
            },

            verifySession: async function(s) {
                try {
                    const doc = await db.collection('activation_codes').where('code', '==', s.code).get();
                    if (!doc.empty) {
                        const data = doc.docs[0].data();
                        this.state.codeDocId = doc.docs[0].id;
                        
                        const statusCheck = this.checkAccountStatus(data);
                        if (statusCheck.valid) {
                            this.state.cid = s.cid;
                            this.state.name = s.name;
                            this.state.phone = s.phone;
                            this.state.admin = s.admin;
                            this.start(s.name, s.phone);
                            
                            if (statusCheck.warning) {
                                document.getElementById('expiryWarning').innerText = this.t('msg_warn');
                                document.getElementById('expiryWarning').style.display = 'block';
                            }
                        } else {
                            this.showBlockScreen(statusCheck.reason);
                        }
                    } else {
                        this.logout();
                    }
                } catch(e) {
                    console.error("Session Check Error", e);
                }
            },

            checkAccountStatus: function(data) {
                if (data.status === 'suspended') return { valid: false, reason: 'suspended' };
                if (data.expiryDate) {
                    const now = new Date();
                    const expiry = new Date(data.expiryDate);
                    const diffTime = expiry - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffTime < 0) return { valid: false, reason: 'expired' };
                    if (diffDays <= 1) return { valid: true, warning: true };
                }
                return { valid: true };
            },

            showBlockScreen: function(reason) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'none';
                const screen = document.getElementById('blockScreen');
                const title = document.getElementById('blockTitle');
                const msg = document.getElementById('blockMsg');
                
                screen.style.display = 'flex';
                if (reason === 'suspended') {
                    msg.innerText = this.t('msg_sus');
                } else {
                    title.innerText = "Subscription Expired";
                    msg.innerText = this.t('msg_exp');
                }
            },

            addDuration: function(date, type) {
                const d = new Date(date);
                if(type === 'day') d.setDate(d.getDate() + 1);
                if(type === 'week') d.setDate(d.getDate() + 7);
                if(type === 'month') d.setMonth(d.getMonth() + 1);
                if(type === 'year') d.setFullYear(d.getFullYear() + 1);
                return d.toISOString();
            },

            formatDate: function(isoString) {
                if (!isoString) return '-';
                const d = new Date(isoString);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            },
            
            randomStr: function(l) {
                const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%'; let r=''; for(let i=0;i<l;i++) r+=c.charAt(Math.floor(Math.random()*c.length)); return r;
            },

            toggleLang: function() {
                this.state.lang = this.state.lang==='ar'?'fr':'ar'; const l = this.state.lang; const d = dict[l];
                document.documentElement.dir = l==='ar'?'rtl':'ltr'; document.getElementById('langBtn').innerText = l==='ar'?'FranÃ§ais':'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
                document.getElementById('t_title').innerText = d.title; document.getElementById('logName').placeholder = d.comp; document.getElementById('logPhone').placeholder = d.phone; document.getElementById('logCode').placeholder = d.code; document.getElementById('logBtn').innerText = d.btn; document.getElementById('t_getcode').innerText = d.get; document.getElementById('t_contact').innerText = d.cont; document.getElementById('t_logout').innerText = d.logout;
                document.querySelectorAll('[data-key]').forEach(el => el.innerText = d[el.getAttribute('data-key')]);
                if(this.state.cid) this.nav(document.querySelector('.nav-item.active') ? document.querySelector('.nav-item.active').getAttribute('onclick').split("'")[1] : 'home');
            },
            t: function(k) { return dict[this.state.lang][k] || k; },
            toggleMenu: function() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('show'); },

            login: async function(e) {
                e.preventDefault(); const btn=document.getElementById('logBtn'); btn.innerText=this.t('wait'); btn.disabled=true;
                const n=document.getElementById('logName').value, p=document.getElementById('logPhone').value, c=document.getElementById('logCode').value;
                try {
                    if(p==='46154399' && c==='371915') { 
                        this.state.admin=true; this.state.cid='ADMIN'; 
                        this.saveSession('ADMIN', 'Admin', '46154399', '371915', true);
                        this.start('Admin','46154399'); return; 
                    }
                    
                    const s = await db.collection('activation_codes').where('code','==',c).get();
                    if(s.empty) throw new Error(this.t('err_login'));
                    
                    const doc = s.docs[0];
                    const d = doc.data();
                    this.state.codeDocId = doc.id;

                    const statusCheck = this.checkAccountStatus(d);
                    if (!statusCheck.valid) {
                        this.showBlockScreen(statusCheck.reason);
                        return;
                    }

                    if((d.targetPhone && d.targetPhone!==p) || (d.used && d.actualPhone!==p)) throw new Error(this.t('err_login'));
                    
                    let cid=d.companyId;
                    if(!d.used) {
                        const r = await db.collection('companies').add({name:n, phone:p, code:c, createdAt:new Date().toISOString()});
                        cid=r.id; 
                        const now = new Date();
                        const expiry = this.addDuration(now, d.subscriptionType || 'month');
                        await db.collection('activation_codes').doc(doc.id).update({
                            used:true, companyId:cid, actualName:n, actualPhone:p, status:'active', 
                            usedAt:now.toISOString(), expiryDate: expiry
                        });
                    }
                    
                    this.state.cid=cid; this.state.name=n; this.state.phone=p;
                    this.saveSession(cid, n, p, c, false);
                    this.start(n,p);

                } catch(er) { alert(er.message); btn.disabled=false; btn.innerText=this.t('btn'); }
            },

            saveSession: function(cid, name, phone, code, isAdmin) {
                localStorage.setItem('mda_session', JSON.stringify({cid, name, phone, code, admin: isAdmin}));
            },

            logout: function() {
                localStorage.removeItem('mda_session');
                location.reload();
            },

            start: function(n,p) { 
                document.getElementById('authScreen').style.display='none'; 
                document.getElementById('appScreen').style.display='flex'; 
                document.getElementById('h_name').innerText=n; 
                document.getElementById('h_phone').innerText=p; 
                if(this.state.admin) document.getElementById('adminLink').style.setProperty('display', 'flex', 'important');
                this.nav('home'); 
            },

            nav: function(page) {
                if(page === 'admin' && !this.state.admin) return;
                document.getElementById('sidebar').classList.remove('open'); document.querySelector('.sidebar-overlay').classList.remove('show');
                document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
                const activeEl = document.querySelector(`.nav-item[onclick="app.nav('${page}')"]`); if(activeEl) activeEl.classList.add('active');
                const ws = document.getElementById('workspace'); ws.innerHTML = '<div style="padding:50px; text-align:center;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>';
                setTimeout(() => {
                    if(page==='home') this.home(ws); else if(page==='pos') this.pos(ws); else if(page==='invoices') this.list(ws, 'invoices'); else if(page==='inventory') this.list(ws, 'products'); else if(page==='expenses') this.list(ws, 'expenses'); else if(page==='salaries') this.list(ws, 'salaries'); else if(page==='reports') this.reports(ws); else if(page==='admin') this.admin(ws);
                }, 50);
            },

            home: function(div) { div.innerHTML = `<div class="card" style="text-align:center; padding:40px;"><img src="https://cdn-icons-png.flaticon.com/512/3135/3135679.png" style="width:80px; margin-bottom:15px;"><h3>${this.state.name}</h3><p>${this.t('sys_active')}</p></div>`; },

            pos: async function(div) {
                this.cart=[]; selectedProduct=null; 
                const s = await db.collection('products').where('companyId','==',this.state.cid).get();
                
                let productsHTML = '';
                s.forEach(d => { 
                    const p = d.data(); 
                    if(p.stock > 0) { 
                        productsHTML += `<div class="prod-card" onclick="app.selectProduct('${d.id}', '${p.name}', ${p.sellPrice}, ${p.buyPrice}, ${p.stock}, this)"><h4>${p.name}</h4><div class="price">${p.sellPrice.toLocaleString()}</div><div class="stock">Stock: ${p.stock}</div></div>`; 
                    } 
                });

                div.innerHTML = `
                    <div class="pos-container">
                        <div class="card" style="display:flex; flex-direction:column; max-height:85vh;">
                            <h3 style="margin:0 0 10px;">${this.t('p_sel')}</h3>
                            <div class="product-grid">${productsHTML || '<p style="text-align:center;width:100%">Empty</p>'}</div>
                            
                            <div id="selectionPanel" class="selected-product-panel">
                                <div class="selected-info"><span id="dispName"></span><span id="dispPrice"></span></div>
                                <div class="action-row">
                                    <input id="sQty" type="number" class="big-qty-input" value="1" min="1" placeholder="1">
                                    <button onclick="app.addToCart()" class="add-btn-large"><i class="fa-solid fa-cart-plus"></i> ${this.t('p_add')}</button>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="background:#fffbeb; height:100%; display:flex; flex-direction:column;">
                            <h3 style="margin:0;">${this.t('inv')}</h3>
                            <div class="cart-items" id="cartContainer"><div style="text-align:center;padding:20px;color:#999">${this.t('empty')}</div></div>
                            <div style="margin-top:auto; padding-top:10px;">
                                <input id="posCust" class="inp" placeholder="${this.t('p_cl')}" style="margin-bottom:5px;">
                                <div id="cartTotal" style="font-size:20px; font-weight:bold; text-align:center; color:var(--primary); margin:10px 0;">0 MRU</div>
                                <button onclick="app.ps()" class="btn btn-prim" style="width:100%; padding:15px; font-size:18px;"><i class="fa-solid fa-print"></i> ${this.t('p_save')}</button>
                            </div>
                        </div>
                    </div>`;
            },
            selectProduct: function(id, name, sell, buy, stock, el) {
                document.querySelectorAll('.prod-card').forEach(e => { e.style.border='1px solid #e9ecef'; e.style.backgroundColor='#f8f9fa'; });
                el.style.border='2px solid var(--primary)'; el.style.backgroundColor='#e3f2fd';
                selectedProduct = { id, name, sell, buy, stock };
                
                document.getElementById('dispName').innerText = name;
                document.getElementById('dispPrice').innerText = sell.toLocaleString() + " MRU";
                const panel = document.getElementById('selectionPanel');
                panel.style.display = 'block';
                const inp = document.getElementById('sQty');
                inp.value = 1; inp.focus();
            },
            addToCart: function() {
                if(!selectedProduct) return alert(this.t('p_sel'));
                const q = Number(document.getElementById('sQty').value);
                if(q<=0) return; if(q>selectedProduct.stock) return alert(this.t('max_qty')+selectedProduct.stock);
                const ex = this.cart.findIndex(i=>i.id===selectedProduct.id);
                if(ex>-1) {
                    if(this.cart[ex].q+q > selectedProduct.stock) return alert(this.t('max_qty')+selectedProduct.stock);
                    this.cart[ex].q+=q; this.cart[ex].t=this.cart[ex].q*this.cart[ex].p;
                } else {
                    this.cart.push({id:selectedProduct.id, n:selectedProduct.name, p:selectedProduct.sell, bp:selectedProduct.buy, q:q, t:selectedProduct.sell*q});
                }
                selectedProduct=null; document.getElementById('selectionPanel').style.display='none';
                document.querySelectorAll('.prod-card').forEach(e => { e.style.border='1px solid #e9ecef'; e.style.backgroundColor='#f8f9fa'; });
                this.renderCart();
            },
            renderCart: function() {
                const c = document.getElementById('cartContainer'); let h=''; let t=0;
                this.cart.forEach((i,x)=>{ t+=i.t; h+=`<div class="cart-item"><div><b>${i.n}</b> <small>(${i.p}x${i.q})</small></div><div style="display:flex;align-items:center;gap:10px;"><b>${i.t}</b><i onclick="app.remCart(${x})" class="fa-solid fa-trash" style="color:red;cursor:pointer"></i></div></div>`; });
                c.innerHTML=h||`<div style="text-align:center;padding:20px;color:#999">${this.t('empty')}</div>`; document.getElementById('cartTotal').innerText=t.toLocaleString()+' MRU';
            },
            remCart: function(x){ this.cart.splice(x,1); this.renderCart(); },
            
            ps: async function() {
                if(!this.cart.length) return alert(this.t('empty'));
                const c=document.getElementById('posCust').value||'Client', t=Number(document.getElementById('cartTotal').innerText.replace(/[^0-9.]/g,''));
                try {
                    const r = await db.collection('invoices').add({companyId:this.state.cid, customer:c, items:this.cart, total:t, createdAt:new Date().toISOString()});
                    for(let i of this.cart) {
                        const ref = db.collection('products').doc(i.id);
                        await db.runTransaction(async tr=>{ const d=await tr.get(ref); tr.update(ref,{stock:d.data().stock-i.q}); });
                    }
                    this.print(r.id,c,t,this.cart); this.nav('pos');
                } catch(e){alert(e.message)}
            },

            list: async function(div, type) {
                div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3>${type==='products'?this.t('stock'):type==='invoices'?this.t('inv'):type==='expenses'?this.t('exp'):this.t('sal')}</h3>${type!=='invoices'?`<button onclick="app.add('${type}')" class="btn btn-prim" style="width:auto;padding:8px 15px;">+</button>`:''}</div><div class="card"><div class="table-scroll"><table id="lst"><thead></thead><tbody><tr><td>Loading...</td></tr></tbody></table></div></div>`;
                const s = await db.collection(type).where('companyId','==',this.state.cid).get();
                let docs = s.docs.map(d=>({id:d.id,...d.data()})); if(type==='invoices') docs.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
                let h='', th='';
                if(type==='invoices') {
                    th=`<tr><th>${this.t('th_date')}</th><th>${this.t('th_client')}</th><th>${this.t('th_amount')}</th><th>${this.t('th_print')}</th></tr>`;
                    docs.forEach(d=>{ 
                        const str=encodeURIComponent(JSON.stringify(d.items)); 
                        const dateFormatted = this.formatDate(d.createdAt);
                        h+=`<tr><td>${dateFormatted}</td><td>${d.customer}</td><td>${d.total}</td><td><button class="btn btn-sec" style="padding:5px;" onclick="app.reprint('${d.id}','${d.customer}',${d.total},'${str}')">${this.t('th_print')}</button></td></tr>`; 
                    });
                } else if(type==='products') {
                    th=`<tr><th>${this.t('th_name')}</th><th>${this.t('th_buy')}</th><th>${this.t('th_sell')}</th><th>${this.t('th_stock')}</th><th>${this.t('th_edit')}</th><th>${this.t('th_del')}</th></tr>`;
                    docs.forEach(d=>h+=`<tr><td>${d.name}</td><td>${d.buyPrice}</td><td>${d.sellPrice}</td><td>${d.stock}</td><td><button onclick="app.editProd('${d.id}',${d.buyPrice},${d.sellPrice})" style="border:none;cursor:pointer">âœ</button></td><td onclick="app.del('${d.id}','${type}')" style="color:red;cursor:pointer">X</td></tr>`);
                } else {
                    th=`<tr><th>${this.t('th_name')}</th><th>${this.t('th_note')}</th><th>${this.t('th_amount')}</th><th>${this.t('th_del')}</th></tr>`;
                    docs.forEach(d=>{ h+=`<tr><td>${d.val1}</td><td>${d.val2}</td><td>${d.val3}</td><td onclick="app.del('${d.id}','${type}')" style="color:red;cursor:pointer">X</td></tr>`; });
                }
                document.querySelector('#lst thead').innerHTML=th; document.querySelector('#lst tbody').innerHTML=h||'<tr><td colspan="4">-</td></tr>';
            },

            add: async function(t) {
                if(t==='products') {
                    const n=prompt(this.t('prompt_name')), b=Number(prompt(this.t('prompt_buy'))), s=Number(prompt(this.t('prompt_sell'))), q=Number(prompt(this.t('prompt_qty')));
                    if(n&&b) {
                        if(s<=b) return alert(this.t('err_price_logic'));
                        await db.collection('products').add({companyId:this.state.cid, name:n, buyPrice:b, sellPrice:s, stock:q, createdAt:new Date().toISOString()});
                        this.nav('inventory');
                    }
                } else {
                    const v1=prompt(this.t('prompt_name')), v2=prompt(this.t('prompt_note')), v3=Number(prompt(this.t('prompt_amount')));
                    if(v1&&v3) { await db.collection(t).add({companyId:this.state.cid, val1:v1, val2:v2, val3:v3, createdAt:new Date().toISOString()}); this.nav(t); }
                }
            },
            editProd: async function(id, b, os) {
                let ns = prompt(this.t('prompt_new_price'), os); if(!ns) return; ns=Number(ns);
                if(ns<=b) return alert(this.t('err_price_logic'));
                await db.collection('products').doc(id).update({sellPrice:ns}); this.nav('inventory');
            },
            del: async function(id, col) { 
                if(confirm(this.t('confirm_del'))) { 
                    if (col === 'products') {
                        const expSnap = await db.collection('expenses').where('relatedId', '==', id).get();
                        expSnap.forEach(doc => { db.collection('expenses').doc(doc.id).delete(); });
                    }
                    await db.collection(col).doc(id).delete(); 
                    this.nav(col==='products'?'inventory':col); 
                } 
            },

            reports: async function(div) {
                div.innerHTML='Loading...';
                const [i,p,e,s] = await Promise.all([
                    db.collection('invoices').where('companyId','==',this.state.cid).get(),
                    db.collection('products').where('companyId','==',this.state.cid).get(),
                    db.collection('expenses').where('companyId','==',this.state.cid).get(),
                    db.collection('salaries').where('companyId','==',this.state.cid).get()
                ]);

                let totalSales = 0;
                let cogs = 0; 
                let unsoldStockValue = 0;
                let generalExpenses = 0; 
                let salaries = 0;

                i.forEach(doc => {
                    const d = doc.data();
                    totalSales += d.total;
                    if(d.items){
                        d.items.forEach(item => {
                            if(item.bp && item.q) cogs += (item.bp * item.q);
                        });
                    }
                });

                p.forEach(doc => {
                    const d = doc.data();
                    if(d.buyPrice && d.stock) unsoldStockValue += (d.buyPrice * d.stock);
                });

                e.forEach(d => generalExpenses += Number(d.data().val3));
                s.forEach(d => salaries += Number(d.data().val3));

                const totalExpenses = cogs + unsoldStockValue + generalExpenses + salaries;
                const netProfit = totalSales - totalExpenses;
                
                div.innerHTML = `
                    <h2>${this.t('rep')}</h2>
                    <div class="grid-stats">
                        <div class="card">
                            <h3>${this.t('income')}</h3>
                            <h2 style="color:green">+${totalSales.toLocaleString()}</h2>
                        </div>
                        <div class="card">
                            <h3>${this.t('expense')}</h3>
                            <h2 style="color:red">-${totalExpenses.toLocaleString()}</h2>
                            <div style="font-size:0.8em; color:#666; text-align:right; margin-top:5px; line-height:1.6;">
                                <div>${this.t('cogs')}: ${cogs.toLocaleString()}</div>
                                <div>${this.t('unsold')}: ${unsoldStockValue.toLocaleString()}</div>
                                <div>${this.t('exp')}: ${(generalExpenses+salaries).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="text-align:center; background:${netProfit>=0?'#d1fae5':'#fee2e2'}">
                        <h3>${this.t('profit')}</h3>
                        <h1>${netProfit.toLocaleString()} MRU</h1>
                    </div>`;
            },

            reprint: function(id, c, t, itemsStr) {
                const items = JSON.parse(decodeURIComponent(itemsStr));
                this.print(id,c,t,items);
            },
            print: function(id, c, t, items) {
                const dir = this.state.lang==='ar'?'rtl':'ltr';
                const d = new Date().toLocaleDateString();
                const formattedDate = this.formatDate(new Date().toISOString());

                const headers = `<tr><th style="border:1px solid #000">${this.t('tbl_prod')}</th><th style="border:1px solid #000">${this.t('tbl_qty')}</th><th style="border:1px solid #000">${this.t('tbl_tot')}</th></tr>`;
                let rows = items.map(i=>`<tr><td style="border:1px solid #000">${i.n}</td><td style="border:1px solid #000">${i.q}</td><td style="border:1px solid #000">${i.t}</td></tr>`).join('');
                document.getElementById('printArea').innerHTML = `
                    <div style="padding:20px; direction:${dir}; font-family:'Tajawal'">
                        <center><h2>${this.state.name}</h2><p>${this.state.phone}</p></center>
                        <hr>
                        <p>INV: ${id.substring(0,5)} | ${formattedDate} <br> ${this.t('th_client')}: ${c}</p>
                        <table style="width:100%; border-collapse:collapse; text-align:center;">
                            ${headers}${rows}
                        </table>
                        <h3>${this.t('p_tot')}: ${t.toLocaleString()} MRU</h3>
                        <center><small>MDA ERP System</small></center>
                    </div>
                `;
                window.print();
            },

            admin: async function(div) {
                div.innerHTML = `
                    <div class="card">
                        <input id="an" class="inp" placeholder="Name">
                        <input id="ap" class="inp" placeholder="Phone">
                        <select id="adur" class="select-dur" style="width:100%;padding:12px;margin-bottom:15px;border-radius:10px;">
                            <option value="day">${this.t('sub_day')}</option>
                            <option value="week">${this.t('sub_week')}</option>
                            <option value="month" selected>${this.t('sub_month')}</option>
                            <option value="year">${this.t('sub_year')}</option>
                        </select>
                        <button onclick="app.gen()" class="btn btn-prim">${this.t('adm_gen')}</button>
                    </div>
                    <div class="card">
                        <div class="table-scroll">
                            <table id="at"><thead></thead><tbody></tbody></table>
                        </div>
                    </div>`;
                
                const s = await db.collection('activation_codes').orderBy('createdAt','desc').limit(50).get();
                let h=`<tr>
                    <th>${this.t('adm_time')}</th>
                    <th>${this.t('adm_code')}</th>
                    <th>${this.t('adm_comp')}</th>
                    <th>${this.t('adm_phone')}</th>
                    <th>Expires</th>
                    <th>${this.t('adm_pay_hist')}</th>
                    <th>${this.t('adm_act')}</th>
                </tr>`;
                let b='';
                
                s.forEach(d=>{
                    const v=d.data();
                    const dateStr = this.formatDate(v.createdAt);
                    const comp = v.actualName || v.targetCompanyName || '-';
                    const ph = v.actualPhone || v.targetPhone || '-';
                    const expDate = v.expiryDate ? new Date(v.expiryDate).toLocaleDateString() : '-';
                    
                    let payHist = '';
                    if(v.paymentHistory) {
                        payHist = `<div class="pay-history">Count: ${v.paymentHistory.length}`;
                        v.paymentHistory.forEach(ph => payHist += `<br>${new Date(ph.date).toLocaleDateString()}`);
                        payHist += '</div>';
                    }

                    b+=`<tr>
                        <td>${dateStr}</td>
                        <td style="font-family:monospace;font-weight:bold">${v.code}</td>
                        <td>${comp}</td>
                        <td>${ph}</td>
                        <td style="color:${new Date(v.expiryDate)<new Date()?'red':'green'}">${expDate}</td>
                        <td>${payHist}</td>
                        <td>
                            <button onclick="app.renewCompany('${d.id}', '${v.subscriptionType||'month'}')" class="btn btn-sec" style="padding:5px;font-size:11px;">${this.t('adm_renew')}</button>
                            <button onclick="app.tst('${d.id}','${v.status}')" class="btn btn-prim" style="padding:5px;font-size:11px;">${v.status==='active'?'Stop':'Start'}</button>
                            <button onclick="app.delCode('${d.id}')" class="btn btn-dan" style="padding:5px;font-size:11px;">Del</button>
                        </td>
                    </tr>`;
                });
                document.querySelector('#at thead').innerHTML=h; document.querySelector('#at tbody').innerHTML=b;
            },

            gen: async function() {
                const n=document.getElementById('an').value, p=document.getElementById('ap').value, dur=document.getElementById('adur').value;
                if(n&&p) { 
                    await db.collection('activation_codes').add({
                        code:this.randomStr(10), targetCompanyName:n, targetPhone:p, 
                        status:'active', used:false, createdAt:new Date().toISOString(),
                        subscriptionType: dur, paymentHistory: []
                    }); 
                    this.nav('admin'); 
                }
            },

            renewCompany: async function(id, type) {
                if(!confirm("Confirm Payment & Renewal?")) return;
                const doc = await db.collection('activation_codes').doc(id).get();
                const data = doc.data();
                let baseDate = new Date();
                if(data.expiryDate && new Date(data.expiryDate) > baseDate) {
                    baseDate = new Date(data.expiryDate);
                }
                const newExpiry = this.addDuration(baseDate, type);
                const payment = { date: new Date().toISOString(), amount: 'Paid', type: type };
                const history = data.paymentHistory || [];
                history.push(payment);

                await db.collection('activation_codes').doc(id).update({
                    expiryDate: newExpiry,
                    paymentHistory: history,
                    status: 'active'
                });
                
                alert("Renewed until: " + new Date(newExpiry).toLocaleDateString());
                this.nav('admin');
            },

            tst: async function(id,st) { await db.collection('activation_codes').doc(id).update({status:st==='active'?'suspended':'active'}); this.nav('admin'); },
            delCode: async function(id) { if(confirm('Delete?')) { await db.collection('activation_codes').doc(id).delete(); this.nav('admin'); } },
        };
        
        window.onload = function() { app.init(); };
    </script>
</body>
</html>