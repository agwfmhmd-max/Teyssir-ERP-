<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teyssir ERP</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a4585">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- بداية التصميم (الألوان) -->
    <style>
        :root { 
            --primary: #00897b; /* لون تيسير الأساسي */
            --accent: #263238; 
            --bg: #f4f6f8;      
            --white: #ffffff;
            --text-dark: #212121; 
            --text-light: #757575;
            --border: #e0e0e0;
            --danger: #d32f2f; 
            --success: #388e3c;
            --header-h: 65px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background-color: var(--bg); color: var(--text-dark); overflow-x: hidden; }

        /* Loader */
        #mainLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 999999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* زر اللغة */
        .lang-btn-style {
            position: fixed; top: 15px; z-index: 20000;
            width: 40px; height: 40px;
            background-color: var(--accent); 
            color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s;
        }
        html[dir="rtl"] .lang-btn-style { left: 20px; } html[dir="ltr"] .lang-btn-style { right: 20px; }

        /* شاشة الدخول */
        .auth-wrap { display: flex; min-height: 100vh; justify-content: center; align-items: center; background: linear-gradient(135deg, #e0f2f1 0%, #ffffff 100%); padding: 20px; }
        .auth-card { background: var(--white); width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        .inp { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 10px; font-size: 16px; margin-bottom: 15px; outline: none; background: #fafafa; color: var(--text-dark); transition: 0.3s; }
        .inp:focus { border-color: var(--primary); background: var(--white); box-shadow: 0 0 0 3px rgba(0, 137, 123, 0.15); }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-prim { background-color: var(--primary); color: white; }
        .btn-sec { background-color: var(--accent); color: white; }
        .btn-dan { background-color: var(--danger); color: white; }

        .wa-link { display: flex; align-items: center; justify-content: center; gap: 10px; background: #25D366; color: white; text-decoration: none; padding: 10px; border-radius: 50px; font-weight: bold; margin-top: 15px; font-size: 14px; }
        #installBtn { display: none; width: 100%; background: var(--accent); color: white; margin-bottom: 15px; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; font-weight: bold; }

        /* التخطيط */
        .app-container { display: none; flex-direction: column; min-height: 100vh; }
        .top-header { height: var(--header-h); background: var(--white); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .menu-btn { font-size: 24px; cursor: pointer; color: var(--primary); padding: 5px; }

        .sidebar { position: fixed; top: 0; bottom: 0; width: 270px; background: var(--white); z-index: 1500; padding-top: 20px; box-shadow: 0 0 30px rgba(0,0,0,0.05); transition: transform 0.3s ease; border-inline-end: 1px solid var(--border); }
        html[dir="rtl"] .sidebar { right: 0; transform: translateX(100%); } html[dir="rtl"] .sidebar.open { transform: translateX(0); }
        html[dir="ltr"] .sidebar { left: 0; transform: translateX(-100%); } html[dir="ltr"] .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1400; display: none; }
        .sidebar-overlay.show { display: block; }

        .nav-item { padding: 14px 20px; display: flex; align-items: center; gap: 12px; color: var(--text-dark); font-weight: 500; cursor: pointer; border-left: 4px solid transparent; border-right: 4px solid transparent; transition: 0.2s; font-size: 15px; }
        .nav-item:hover { background: #e0f2f1; color: var(--primary); }
        .nav-item.active { background: #e0f2f1; color: var(--primary); border-color: var(--primary); }

        .main-content { flex: 1; padding: 20px; overflow-y: auto; }

        /* الكروت والشبكة */
        .card { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid var(--border); }
        .home-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .home-card { background: white; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 130px; }
        .home-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0, 137, 123, 0.1); }
        .home-icon { font-size: 35px; margin-bottom: 10px; color: var(--primary); }
        .home-label { font-weight: bold; color: var(--text-dark); font-size: 14px; }

        /* الجداول */
        .table-scroll { overflow-x: auto; border: 1px solid var(--border); border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th, td { padding: 12px; text-align: start; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text-dark); }
        th { background-color: #fafafa; font-weight: bold; color: var(--primary); white-space: nowrap; }

        /* نقطة البيع */
        .pos-container { display: grid; gap: 20px; }
        @media(min-width: 768px) { .pos-container { height: calc(100vh - 120px); grid-template-columns: 1.6fr 1fr; } .sidebar { position: fixed; top: var(--header-h); bottom: 0; width: 250px; transform: none !important; box-shadow: none; border-inline-end: 1px solid var(--border); z-index: 900; } html[dir="rtl"] .main-content { margin-right: 250px; } html[dir="ltr"] .main-content { margin-left: 250px; } .menu-btn, .sidebar-overlay { display: none !important; } }
        
        .search-results { position: absolute; top: 75px; left: 15px; right: 15px; background: white; border: 1px solid #ddd; border-radius: 8px; z-index: 100; max-height: 250px; overflow-y: auto; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .search-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .search-item:hover { background: #e0f2f1; }
        
        .big-qty-input { width: 60px; text-align: center; font-size: 18px; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }
        .add-btn-large { flex: 1; padding: 10px; background-color: var(--success); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .cart-items { flex: 1; overflow-y: auto; margin-bottom: 10px; min-height: 150px; border: 1px solid #eee; border-radius: 8px; padding: 5px; }
        .cart-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0; align-items: center; }

        /* الحظر والتنبيهات */
        .block-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; z-index: 60000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; }
        .welcome-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 70000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .welcome-content { background: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 20px; text-align: center; border-top: 5px solid var(--primary); animation: zoomIn 0.3s ease; }
        @keyframes zoomIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }

        .expiry-warning { background: #fff8e1; color: #f57f17; padding: 8px; text-align: center; font-size: 12px; font-weight: bold; border-bottom: 1px solid #ffecb3; display: none; position: fixed; top: 0; width: 100%; z-index: 1050; }
        #adminLink { display: none; }
        
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .print-box { display: none; }
        @media print { .app-container, .auth-wrap, .lang-btn-style, #expiryWarning, #mainLoader { display: none !important; } .print-box { display: block !important; position: absolute; top:0; left:0; width:100%; background:white; color: black; } table th, table td { border: 1px solid #000; color: black; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="mainLoader"><div class="spinner"></div><p style="color:var(--primary);font-weight:bold;">Teyssir ERP...</p></div>
    
    <button onclick="app.toggleLang()" class="lang-btn-style"><i class="fa-solid fa-language"></i></button>
    <div id="expiryWarning"></div>

    <!-- ترحيب -->
    <div id="welcomeModal" class="welcome-modal">
        <div class="welcome-content">
            <img src="logo.png" style="width:80px; margin-bottom:15px; border-radius:15px;">
            <h2 style="color:var(--primary); margin-top:0;" data-key="w_title">مرحباً بك</h2>
            <p style="color:#666; margin-bottom:20px;" data-key="w_text">النظام المتكامل لإدارة الأعمال.</p>
            <a href="https://wa.me/22220479962" class="wa-link" style="margin-bottom:20px; justify-content:center;">
                <i class="fa-brands fa-whatsapp"></i> <span data-key="cont">تواصل مع المطور</span>
            </a>
            <button onclick="app.closeWelcome()" class="btn btn-prim" style="width:100%;" data-key="w_btn">فهمت</button>
        </div>
    </div>

    <!-- حظر -->
    <div id="blockScreen" class="block-screen">
        <i class="fa-solid fa-lock" style="font-size:60px; color:var(--danger); margin-bottom:20px;"></i>
        <h2 style="color:var(--danger); margin-bottom:10px;" data-key="msg_sus">الحساب معلق</h2>
        <p style="color:#666; margin-bottom:30px;" data-key="msg_exp">انتهت فترة الاشتراك.</p>
        <a href="https://wa.me/22220479962" class="wa-link" style="width:auto; padding:12px 40px; border-radius:50px;">
            <i class="fa-brands fa-whatsapp"></i> <span data-key="pay_now">تواصل للدفع</span>
        </a>
        <button onclick="app.logout()" class="btn btn-dan" style="margin-top:20px; width:auto;">
            <i class="fa-solid fa-right-from-bracket"></i> <span data-key="logout">خروج</span>
        </button>
    </div>

    <!-- Auth -->
    <div id="authScreen" class="auth-wrap">
        <div class="auth-card">
            <img src="logo.png" style="width:90px; margin-bottom:15px; border-radius:15px;">
            <h2 style="color:var(--primary); margin:0 0 20px;" data-key="title">Teyssir ERP</h2>
            <div id="installBtn" onclick="app.installPWA()"><i class="fa-solid fa-download"></i> <span data-key="t_install">تثبيت التطبيق</span></div>
            <form onsubmit="app.login(event)">
                <input id="logName" class="inp" data-ph="comp" placeholder="اسم الشركة" required>
                <input id="logPhone" type="tel" class="inp" data-ph="phone" placeholder="رقم الهاتف" required>
                <input id="logCode" type="password" class="inp" data-ph="code" placeholder="رمز التفعيل" required>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                     <button type="submit" id="logBtn" class="btn btn-prim" style="flex:1" data-key="btn">دخول</button>
                     <button type="button" onclick="app.startTrial()" class="btn btn-sec" style="flex:1" data-key="btn_trial">تجربة</button>
                </div>
            </form>
            <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                <a href="https://wa.me/22220479962" class="wa-link"><i class="fa-brands fa-whatsapp"></i> <span data-key="cont">تواصل مع المطور</span></a>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="appScreen" class="app-container">
        <div class="sidebar-overlay" onclick="app.toggleMenu()"></div>
        <header class="top-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="menu-btn" onclick="app.toggleMenu()"><i class="fa-solid fa-bars"></i></div>
                <div><div id="h_name" style="font-weight:bold; color:var(--primary); font-size:1.1em;"></div><div id="h_phone" style="font-size:12px; color:#888;"></div></div>
            </div>
        </header>
        
        <aside class="sidebar" id="sidebar">
            <div style="padding: 20px; text-align:center; border-bottom:1px solid var(--border);">
                <img src="logo.png" style="width:60px; border-radius:10px;">
                <h4 style="margin:10px 0 0; color:var(--primary);">Teyssir ERP</h4>
            </div>
            <div style="padding: 10px 0; overflow-y:auto; flex:1;">
                <div class="nav-item active" onclick="app.nav('home')"><i class="fa-solid fa-home"></i> <span data-key="home">الرئيسية</span></div>
                <div class="nav-item" onclick="app.nav('pos')"><i class="fa-solid fa-cash-register"></i> <span data-key="pos">نقطة البيع</span></div>
                <div class="nav-item" onclick="app.nav('customers')"><i class="fa-solid fa-users"></i> <span data-key="customers">الزبناء</span></div>
                <div class="nav-item" onclick="app.nav('suppliers')"><i class="fa-solid fa-truck-field"></i> <span data-key="suppliers">الموردين</span></div>
                <div class="nav-item" onclick="app.nav('banks')"><i class="fa-solid fa-building-columns"></i> <span data-key="banks">البنوك</span></div>
                <div class="nav-item" onclick="app.nav('revenue')"><i class="fa-solid fa-hand-holding-dollar"></i> <span data-key="revenue">الإيرادات</span></div>
                <div class="nav-item" onclick="app.nav('invoices')"><i class="fa-solid fa-file-invoice"></i> <span data-key="inv">الفواتير</span></div>
                <div class="nav-item" onclick="app.nav('inventory')"><i class="fa-solid fa-boxes-stacked"></i> <span data-key="stock">المخزون</span></div>
                <div class="nav-item" onclick="app.nav('expenses')"><i class="fa-solid fa-wallet"></i> <span data-key="exp">المصروفات</span></div>
                <div class="nav-item" onclick="app.nav('salaries')"><i class="fa-solid fa-users-gear"></i> <span data-key="sal">الرواتب</span></div>
                <div class="nav-item" onclick="app.nav('reports')"><i class="fa-solid fa-chart-pie"></i> <span data-key="rep">التقارير</span></div>
                <div id="adminLink" class="nav-item" onclick="app.nav('admin')" style="color:var(--danger); margin-top:10px;"><i class="fa-solid fa-lock"></i> Admin</div>
            </div>
        </aside>
        
        <main id="workspace" class="main-content"></main>
    </div>

    <!-- نافذة الدفع -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary);" data-key="pay_title">تفاصيل الدفع</h3>
            <div style="background:#f4f6f8; padding:15px; margin-bottom:15px; border-radius:10px; text-align:center;">
                <span style="font-size:14px; color:#666;" data-key="p_tot">الإجمالي</span><br>
                <strong id="payTotalDisplay" style="font-size:24px; color:var(--primary);">0</strong>
            </div>
            
            <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;" data-key="p_cl">الزبون</label>
            <select id="payCustomer" class="inp" style="width:100%;"></select>
            
            <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;" data-key="th_amount">المبلغ المدفوع</label>
            <input type="number" id="payAmount" class="inp" placeholder="0" oninput="app.calcDebt()">
            
            <div style="color:var(--danger); font-size:13px; margin-bottom:15px; font-weight:bold;" id="debtDisplay"></div>
            
            <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;">طريقة الدفع</label>
            <select id="payMethod" class="inp" onchange="app.toggleBankSelect()" style="width:100%;">
                <option value="cash" data-key="pay_cash">كاش</option>
                <option value="bank" data-key="pay_bank">بنك</option>
            </select>
            
            <div id="bankSelectDiv" style="display:none; margin-top:10px;">
                <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;" data-key="banks">البنك</label>
                <select id="payBank" class="inp" style="width:100%;"></select>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="app.confirmInvoice()" class="btn btn-prim" style="flex:1" data-key="p_save">حفظ</button>
                <button onclick="document.getElementById('paymentModal').style.display='none'" class="btn btn-dan" style="flex:1">X</button>
            </div>
        </div>
    </div>

    <div id="printArea" class="print-box"></div>

    <script>
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; const btn=document.getElementById('installBtn'); if(btn) btn.style.display = 'block'; });

        const firebaseConfig = {
            apiKey: "AIzaSyA6glwj94Onm0r6gRtxtoyqEISpPChDcHo",
            authDomain: "comptabilite-e35ed.firebaseapp.com",
            projectId: "comptabilite-e35ed",
            storageBucket: "comptabilite-e35ed.firebasestorage.app",
            messagingSenderId: "59372022194",
            appId: "1:59372022194:web:22b9f70c41b1479835dcab",
            measurementId: "G-EEDNJXLSN6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let sessionListener = null;
        let selectedProduct = null;
        let allProductsCache = []; 

        const dict = {
            ar: {
                home:"الرئيسية", pos:"نقطة البيع", customers:"الزبناء", suppliers:"الموردين", banks:"البنوك",
                revenue:"الإيرادات", inv:"الفواتير", stock:"المخزون", exp:"المصروفات", sal:"الرواتب", rep:"التقارير",
                search_ph: "بحث عن منتج...", p_add: "إضافة", p_sel: "بحث عن منتج", p_save: "دفع وحفظ", p_tot: "الإجمالي",
                empty: "فارغة",
                pay_title: "تفاصيل الدفع", pay_cash: "كاش", pay_bank: "بنك", pay_now: "تواصل للدفع",
                btn: "دخول", btn_trial: "تجربة", t_install: "تثبيت",
                title: "تسجيل الدخول", comp:"اسم الشركة", phone:"الهاتف", code:"الرمز",
                w_title: "مرحباً بك", w_text: "رفيقك في التسيير", w_btn: "فهمت", cont: "تواصل مع المطور",
                rep_daily: "يومي", rep_monthly: "شهري", rep_all: "الكل", rep_filter: "تصفية",
                rep_sales_det: "تفاصيل المبيعات", rep_exp_det: "تفاصيل المصروفات",
                th_inv_no: "رقم الفاتورة", th_profit: "الربح", th_type: "النوع",
                income:"المبيعات", cogs:"تكلفة المبيعات", expense:"المصروفات", profit:"الربح الصافي",
                th_date:"التاريخ", th_client:"العميل", th_amount:"المبلغ", th_note:"ملاحظة",
                msg_sus: "الحساب معطل", msg_exp: "انتهى الاشتراك", msg_warn: "⚠️ تحذير: اشتراكك ينتهي قريباً",
                adm_time: "التاريخ", adm_comp: "الشركة", adm_phone: "الهاتف", adm_code: "الرمز", adm_stat: "الحالة", adm_act: "التحكم",
                adm_gen: "توليد", adm_renew: "تجديد", adm_stop: "تجميد", adm_start: "تفعيل", adm_del: "حذف"
            },
            fr: {
                home:"Accueil", pos:"Vente", customers:"Clients", suppliers:"Fournisseurs", banks:"Banques",
                revenue:"Revenus", inv:"Factures", stock:"Stock", exp:"Dépenses", sal:"Salaires", rep:"Rapports",
                search_ph: "Rechercher...", p_add: "Ajouter", p_sel: "Recherche", p_save: "Payer", p_tot: "Total",
                empty: "Vide",
                pay_title: "Détails Paiement", pay_cash: "Espèces", pay_bank: "Banque", pay_now: "Payer maintenant",
                btn: "Entrer", btn_trial: "Essai", t_install: "Installer",
                title: "Connexion", comp:"Société", phone:"Tél", code:"Code",
                w_title: "Bienvenue", w_text: "Votre partenaire de gestion", w_btn: "Compris", cont: "Contacter Développeur",
                rep_daily: "Journalier", rep_monthly: "Mensuel", rep_all: "Tout", rep_filter: "Filtrer",
                rep_sales_det: "Détails Ventes", rep_exp_det: "Détails Dépenses",
                th_inv_no: "N° Facture", th_profit: "Profit", th_type: "Type",
                income:"Ventes", cogs:"Coût Ventes", expense:"Dépenses", profit:"Net",
                th_date:"Date", th_client:"Client", th_amount:"Montant", th_note:"Note",
                msg_sus: "Suspendu", msg_exp: "Expiré", msg_warn: "⚠️ Attention: Expire bientôt",
                adm_time: "Date", adm_comp: "Société", adm_phone: "Tél", adm_code: "Code", adm_stat: "Statut", adm_act: "Action",
                adm_gen: "Générer", adm_renew: "Renouveler", adm_stop: "Suspendre", adm_start: "Activer", adm_del: "Supprimer"
            }
        };

        const app = {
            state: { cid:null, name:'', phone:'', admin:false, lang:'ar', currentView:'home' },
            cart: [],

            init: function() {
                this.showLoader();
                const session = localStorage.getItem('mda_session');
                if(session) this.verifySession(JSON.parse(session));
                else { 
                    this.hideLoader(); 
                    if(!localStorage.getItem('welcome')) document.getElementById('welcomeModal').style.display='flex';
                    document.getElementById('authScreen').style.display='flex'; 
                }
            },
            showLoader: function() { document.getElementById('mainLoader').style.display = 'flex'; },
            hideLoader: function() { document.getElementById('mainLoader').style.display = 'none'; },
            
            closeWelcome: function() {
                document.getElementById('welcomeModal').style.display='none';
                localStorage.setItem('welcome', '1');
            },

            toggleLang: function() {
                this.state.lang = this.state.lang==='ar'?'fr':'ar';
                document.documentElement.dir = this.state.lang==='ar'?'rtl':'ltr';
                const d = dict[this.state.lang];
                document.querySelectorAll('[data-key]').forEach(el => el.innerText = d[el.getAttribute('data-key')] || el.innerText);
                document.querySelectorAll('[data-ph]').forEach(el => el.placeholder = d[el.getAttribute('data-ph')] || el.placeholder);
                if(this.state.cid) this.nav(this.state.currentView);
            },
            t: function(k) { return dict[this.state.lang][k] || k; },

            verifySession: async function(s) {
                if(s.admin) { 
                    this.state.cid='ADMIN'; this.state.name='Admin'; this.state.admin=true; 
                    this.start('Admin', '46154399'); 
                    return; 
                }
                
                // Monitor Session
                sessionListener = db.collection('activation_codes').doc(s.codeDocId)
                    .onSnapshot((doc) => {
                        if (!doc.exists) { this.logout(); return; }
                        const data = doc.data();
                        
                        if (data.status === 'suspended') { this.showBlock('suspended'); return; }
                        if (data.expiryDate && new Date() > new Date(data.expiryDate)) { this.showBlock('expired'); return; }
                        
                        // Check expiry warning
                        if(data.expiryDate) {
                            const diff = (new Date(data.expiryDate) - new Date()) / (1000*60*60*24);
                            if(diff <= 1) { 
                                document.getElementById('expiryWarning').innerText = this.t('msg_warn');
                                document.getElementById('expiryWarning').style.display = 'block';
                            } else {
                                document.getElementById('expiryWarning').style.display = 'none';
                            }
                        }

                        if(document.getElementById('authScreen').style.display !== 'none' || document.getElementById('blockScreen').style.display !== 'none') {
                            this.state.cid = s.cid; this.state.name = s.name; this.state.phone = s.phone;
                            this.start(s.name, s.phone);
                        }
                    });
            },

            showBlock: function(reason) {
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('blockScreen').style.display = 'flex';
                document.getElementById('blockTitle').innerText = reason==='suspended' ? this.t('msg_sus') : this.t('msg_exp');
                this.hideLoader();
            },

            login: async function(e) {
                e.preventDefault(); this.showLoader();
                const n=document.getElementById('logName').value, p=document.getElementById('logPhone').value, c=document.getElementById('logCode').value;
                try {
                    if(p==='46154399' && c==='371915') { 
                        const s = {cid:'ADMIN', name:'Admin', admin:true};
                        localStorage.setItem('mda_session', JSON.stringify(s));
                        location.reload(); return; 
                    }
                    const s = await db.collection('activation_codes').where('code','==',c).get();
                    if(s.empty) throw new Error(this.t('err_login'));
                    
                    const doc = s.docs[0]; const d = doc.data();
                    if(d.status==='suspended') { this.showBlock('suspended'); return; }
                    if(d.targetPhone && d.targetPhone!==p) throw new Error(this.t('err_login'));
                    
                    let cid=d.companyId;
                    if(!d.used) {
                        const r = await db.collection('companies').add({name:n, phone:p, code:c, createdAt:new Date().toISOString()});
                        cid=r.id; 
                        const now = new Date(); const expiry = new Date(); expiry.setMonth(expiry.getMonth()+1);
                        if(d.isTrial) expiry.setTime(now.getTime() + 3600000); // 1h trial
                        
                        await db.collection('activation_codes').doc(doc.id).update({
                            used:true, companyId:cid, actualName:n, actualPhone:p, status:'active', usedAt:now.toISOString(), expiryDate:expiry.toISOString()
                        });
                    }
                    
                    const sess = {cid, name:n, phone:p, codeDocId:doc.id, code:c};
                    localStorage.setItem('mda_session', JSON.stringify(sess));
                    this.verifySession(sess);

                } catch(er) { this.hideLoader(); alert(er.message); }
            },

            startTrial: async function() {
                if(localStorage.getItem('mda_trial_done')) return alert("Trial already used");
                this.showLoader();
                const n = document.getElementById('logName').value;
                const p = document.getElementById('logPhone').value;
                if(!n || !p) { this.hideLoader(); return alert("Name/Phone required"); }

                try {
                    const tCode = 'TR-'+Math.floor(Math.random()*100000);
                    const now = new Date();
                    const expiry = new Date(now.getTime() + 3600000); // 1 Hour

                    const codeRef = await db.collection('activation_codes').add({
                        code: tCode, targetCompanyName: n, targetPhone: p,
                        status: 'active', used: true, usedAt: now.toISOString(),
                        expiryDate: expiry.toISOString(), subscriptionType: 'trial',
                        isTrial: true
                    });

                    const compRef = await db.collection('companies').add({ name: n, phone: p, code: tCode, createdAt: now.toISOString() });
                    await codeRef.update({ companyId: compRef.id, actualName: n, actualPhone: p });
                    
                    localStorage.setItem('mda_trial_done', 'true');
                    const sess = {cid:compRef.id, name:n, phone:p, codeDocId:codeRef.id, code:tCode};
                    localStorage.setItem('mda_session', JSON.stringify(sess));
                    this.verifySession(sess);

                } catch(e) { this.hideLoader(); alert(e.message); }
            },

            logout: function() { localStorage.removeItem('mda_session'); location.reload(); },
            
            start: function(n,p) {
                this.hideLoader();
                document.getElementById('authScreen').style.display='none';
                document.getElementById('blockScreen').style.display='none';
                document.getElementById('appScreen').style.display='flex';
                document.getElementById('h_name').innerText=n;
                document.getElementById('h_phone').innerText=p;
                if(this.state.admin) document.getElementById('adminLink').style.display='flex';
                this.nav('home');
            },

            nav: function(page) {
                this.state.currentView = page;
                document.getElementById('sidebar').classList.remove('open');
                document.querySelector('.sidebar-overlay').classList.remove('show');
                const ws = document.getElementById('workspace');
                ws.innerHTML = '<div style="padding:50px; text-align:center;"><div class="spinner"></div></div>';
                
                setTimeout(() => {
                    switch(page) {
                        case 'home': this.home(ws); break;
                        case 'pos': this.pos(ws); break;
                        case 'customers': this.renderPeople(ws, 'customers', this.t('customers')); break;
                        case 'suppliers': this.renderPeople(ws, 'suppliers', this.t('suppliers')); break;
                        case 'banks': this.renderBanks(ws); break;
                        case 'revenue': this.renderRevenue(ws); break;
                        case 'invoices': this.list(ws, 'invoices'); break;
                        case 'inventory': this.list(ws, 'products'); break;
                        case 'expenses': this.list(ws, 'expenses'); break;
                        case 'salaries': this.list(ws, 'salaries'); break;
                        case 'reports': this.reports(ws); break;
                        case 'admin': this.admin(ws); break;
                    }
                }, 50);
            },

            // --- Home Grid ---
            home: function(div) {
                const items = [
                    {k:'pos', i:'fa-cart-shopping', a:"app.nav('pos')"}, {k:'inv', i:'fa-file-invoice-dollar', a:"app.nav('invoices')"},
                    {k:'customers', i:'fa-users', a:"app.nav('customers')"}, {k:'suppliers', i:'fa-truck-field', a:"app.nav('suppliers')"},
                    {k:'stock', i:'fa-boxes-stacked', a:"app.nav('inventory')"}, {k:'banks', i:'fa-building-columns', a:"app.nav('banks')"},
                    {k:'exp', i:'fa-wallet', a:"app.nav('expenses')"}, {k:'revenue', i:'fa-hand-holding-dollar', a:"app.nav('revenue')"},
                    {k:'sal', i:'fa-users-gear', a:"app.nav('salaries')"}, {k:'rep', i:'fa-chart-pie', a:"app.nav('reports')"}
                ];
                let h = '<div class="home-grid">';
                items.forEach(it => { h += `<div class="home-card" onclick="${it.a}"><div class="home-icon"><i class="fa-solid ${it.i}"></i></div><div class="home-label" data-key="${it.k}">${this.t(it.k)}</div></div>`; });
                h += '</div>'; div.innerHTML = h;
            },

            // --- POS ---
            pos: async function(div) {
                this.cart = [];
                const snap = await db.collection('products').where('companyId','==',this.state.cid).get();
                allProductsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                div.innerHTML = `
                    <div class="pos-container">
                        <div class="card" style="position:relative; height:100%; display:flex; flex-direction:column;">
                            <h3 style="color:var(--primary); margin-top:0;" data-key="p_sel">${this.t('p_sel')}</h3>
                            <input id="prodSearch" class="inp" placeholder="${this.t('search_ph')}" oninput="app.searchProduct(this.value)" autocomplete="off">
                            <div id="searchResults" class="search-results"></div>
                            <div id="posAction" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                    <strong id="selName" style="color:var(--primary); font-size:18px;"></strong>
                                    <strong id="selPrice" style="color:var(--success);"></strong>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <input id="selQty" type="number" class="big-qty-input" value="1" min="1">
                                    <button onclick="app.addToCart()" class="add-btn-large">${this.t('p_add')}</button>
                                </div>
                            </div>
                        </div>
                        <div class="card" style="background:#fff; border:1px solid var(--primary); display:flex; flex-direction:column;">
                            <div class="cart-items" id="cartContainer" style="flex:1;"></div>
                            <div style="border-top:1px solid #eee; padding-top:10px; margin-top:10px;">
                                <div style="display:flex; justify-content:space-between; font-size:18px; font-weight:bold; margin-bottom:10px;">
                                    <span data-key="p_tot">${this.t('p_tot')}</span><span id="cartTotal">0</span>
                                </div>
                                <button onclick="app.openPaymentModal()" class="btn btn-prim" style="width:100%" data-key="p_save">${this.t('p_save')}</button>
                            </div>
                        </div>
                    </div>`;
            },
            searchProduct: function(val) {
                const resDiv = document.getElementById('searchResults');
                if(val.length < 1) { resDiv.style.display = 'none'; return; }
                const results = allProductsCache.filter(p => p.name.toLowerCase().includes(val.toLowerCase()) && p.stock > 0);
                let html = '';
                results.forEach(p => { html += `<div class="search-item" onclick="app.selectForPos('${p.id}')"><span>${p.name}</span><span style="font-weight:bold; color:var(--primary)">${p.sellPrice}</span></div>`; });
                resDiv.innerHTML = html || '<div style="padding:10px;">No results</div>'; resDiv.style.display = 'block';
            },
            selectForPos: function(id) {
                const p = allProductsCache.find(x => x.id === id); selectedProduct = p;
                document.getElementById('searchResults').style.display = 'none'; document.getElementById('prodSearch').value = '';
                document.getElementById('posAction').style.display = 'block';
                document.getElementById('selName').innerText = p.name; document.getElementById('selPrice').innerText = p.sellPrice;
                document.getElementById('selQty').value = 1; document.getElementById('selQty').focus();
            },
            addToCart: function() {
                const q = Number(document.getElementById('selQty').value);
                if(q > selectedProduct.stock) return alert("Max: " + selectedProduct.stock);
                this.cart.push({ id: selectedProduct.id, n: selectedProduct.name, p: selectedProduct.sellPrice, bp: selectedProduct.buyPrice, q: q, t: selectedProduct.sellPrice * q });
                document.getElementById('posAction').style.display = 'none'; selectedProduct = null; this.renderCart();
            },
            renderCart: function() {
                let h='', t=0; this.cart.forEach((i,x)=>{ t+=i.t; h+=`<div class="cart-item"><span>${i.n} (${i.q})</span><span>${i.t}</span><i class="fa-solid fa-trash" style="color:red;cursor:pointer" onclick="app.remCart(${x})"></i></div>`; });
                document.getElementById('cartContainer').innerHTML = h; document.getElementById('cartTotal').innerText = t.toLocaleString();
            },
            remCart: function(x) { this.cart.splice(x,1); this.renderCart(); },

            // Payment
            openPaymentModal: async function() {
                if(!this.cart.length) return alert("Empty");
                const custs = await db.collection('customers').where('companyId','==',this.state.cid).get();
                const banks = await db.collection('banks').where('companyId','==',this.state.cid).get();
                let cOpts = '<option value="">No Debt</option>'; custs.forEach(d => cOpts += `<option value="${d.id}">${d.data().name}</option>`);
                let bOpts = ''; banks.forEach(d => bOpts += `<option value="${d.id}">${d.data().name}</option>`);
                document.getElementById('payCustomer').innerHTML = cOpts; document.getElementById('payBank').innerHTML = bOpts;
                const total = Number(document.getElementById('cartTotal').innerText.replace(/[^0-9.]/g,''));
                document.getElementById('payTotalDisplay').innerText = total; document.getElementById('payAmount').value = total; this.calcDebt();
                document.getElementById('paymentModal').style.display = 'flex';
            },
            calcDebt: function() {
                const total = Number(document.getElementById('payTotalDisplay').innerText); const paid = Number(document.getElementById('payAmount').value);
                const debt = total - paid; document.getElementById('debtDisplay').innerText = debt > 0 ? `Debt: ${debt}` : "";
            },
            toggleBankSelect: function() {
                const m = document.getElementById('payMethod').value; document.getElementById('bankSelectDiv').style.display = m==='bank'?'block':'none';
            },
            confirmInvoice: async function() {
                const custId = document.getElementById('payCustomer').value;
                const paid = Number(document.getElementById('payAmount').value);
                const total = Number(document.getElementById('payTotalDisplay').innerText);
                const method = document.getElementById('payMethod').value;
                const bankId = document.getElementById('payBank').value;
                const remaining = total - paid;

                if (remaining > 0 && !custId) return alert("Customer required for debt");
                if (method === 'bank' && !bankId) return alert("Select Bank");

                const batch = db.batch();
                const invRef = db.collection('invoices').doc();
                const invNum = 'INV-' + Date.now().toString().slice(-4);
                
                batch.set(invRef, {
                    companyId: this.state.cid, number: invNum, customerId: custId || null,
                    items: this.cart, total: total, paid: paid, remaining: remaining,
                    method: method, bankId: bankId || null, createdAt: new Date().toISOString(),
                    customer: custId ? document.getElementById('payCustomer').selectedOptions[0].text : "General"
                });

                this.cart.forEach(item => {
                    const ref = db.collection('products').doc(item.id);
                    batch.update(ref, { stock: firebase.firestore.FieldValue.increment(-item.q) });
                });

                if(remaining > 0 && custId) {
                    const cRef = db.collection('customers').doc(custId);
                    batch.update(cRef, { debt: firebase.firestore.FieldValue.increment(remaining) });
                }

                if(paid > 0) {
                    if(method === 'bank') {
                        const bRef = db.collection('banks').doc(bankId);
                        batch.update(bRef, { balance: firebase.firestore.FieldValue.increment(paid) });
                        batch.set(db.collection('bank_transactions').doc(), {companyId:this.state.cid, bankId, type:'deposit', amount:paid, date:new Date().toISOString()});
                    } else {
                        batch.set(db.collection('revenue').doc(), {companyId:this.state.cid, type:'sales', amount:paid, date:new Date().toISOString()});
                    }
                }

                await batch.commit();
                document.getElementById('paymentModal').style.display = 'none';
                this.nav('pos');
            },

            // --- LISTS ---
            list: async function(div, type) {
                div.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>${this.t(type)}</h3><button onclick="app.add('${type}')" class="btn btn-prim">+</button></div><div class="card"><div class="table-scroll"><table id="lst"><thead></thead><tbody></tbody></table></div></div>`;
                const s = await db.collection(type).where('companyId','==',this.state.cid).get();
                let docs = s.docs.map(d=>({id:d.id,...d.data()}));
                if(type==='invoices') docs.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
                
                let h='', th='';
                if(type==='invoices') {
                    th=`<tr><th>${this.t('th_inv_no')}</th><th>${this.t('th_date')}</th><th>${this.t('th_client')}</th><th>${this.t('th_amount')}</th></tr>`;
                    docs.forEach(d=>{ h+=`<tr><td>${d.number}</td><td>${new Date(d.createdAt).toLocaleDateString()}</td><td>${d.customer}</td><td>${d.total}</td></tr>`; });
                } else if(type==='products') {
                    th=`<tr><th>${this.t('th_name')}</th><th>${this.t('th_stock')}</th><th>X</th></tr>`;
                    docs.forEach(d=>{ h+=`<tr><td>${d.name}</td><td>${d.stock}</td><td><button onclick="app.del('${d.id}','${type}')">X</button></td></tr>`; });
                } else {
                    th=`<tr><th>${this.t('th_date')}</th><th>${this.t('th_note')}</th><th>${this.t('th_amount')}</th></tr>`;
                    docs.forEach(d=>{ if(type==='expenses' && d.type==='purchase') return; h+=`<tr><td>${new Date(d.createdAt).toLocaleDateString()}</td><td>${d.val1}</td><td>${d.val3}</td></tr>`; });
                }
                document.querySelector('#lst thead').innerHTML=th; document.querySelector('#lst tbody').innerHTML=h;
            },

            // --- REPORTS ---
            reports: async function(div) {
                div.innerHTML = `<h2>${this.t('rep')}</h2>
                    <div class="filters-bar">
                        <button onclick="app.filterReports('day')" class="filter-btn active">${this.t('rep_daily')}</button>
                        <button onclick="app.filterReports('month')" class="filter-btn">${this.t('rep_monthly')}</button>
                    </div>
                    <div id="reportContent">Loading...</div>`;
                this.filterReports('day');
            },
            filterReports: async function(type) {
                let start = new Date(0), end = new Date(); end.setHours(23,59,59,999);
                if(type==='day') { start = new Date(); start.setHours(0,0,0,0); }
                else if(type==='month') { start = new Date(); start.setDate(1); start.setHours(0,0,0,0); }
                
                const [i, e, s] = await Promise.all([
                    db.collection('invoices').where('companyId','==',this.state.cid).get(),
                    db.collection('expenses').where('companyId','==',this.state.cid).get(),
                    db.collection('salaries').where('companyId','==',this.state.cid).get()
                ]);
                
                let sales=0, cogs=0, exp=0;
                let sRows = '';
                
                i.docs.forEach(doc => {
                    const d = doc.data();
                    if(new Date(d.createdAt) >= start && new Date(d.createdAt) <= end) {
                        sales += d.total;
                        let cost = 0; if(d.items) d.items.forEach(it => cost += (it.bp||0) * it.q);
                        cogs += cost;
                        sRows += `<tr><td>${d.number}</td><td>${d.customer}</td><td>${d.total}</td><td>${d.total-cost}</td></tr>`;
                    }
                });
                
                e.docs.forEach(d => { if(d.data().type!=='purchase' && new Date(d.data().createdAt)>=start) exp += d.data().val3; });
                s.docs.forEach(d => { if(new Date(d.data().createdAt)>=start) exp += d.data().val3; });
                const netProfit = sales - cogs - exp;

                document.getElementById('reportContent').innerHTML = `
                    <div class="grid-stats">
                        <div class="card"><h3>${this.t('income')}</h3><h2 style="color:green">${sales}</h2></div>
                        <div class="card"><h3>${this.t('profit')}</h3><h2 style="color:blue">${netProfit}</h2></div>
                    </div>
                    <h3 style="margin-top:20px;">${this.t('rep_sales_det')}</h3>
                    <div class="table-scroll"><table><thead><tr><th>${this.t('th_inv_no')}</th><th>${this.t('th_client')}</th><th>${this.t('th_amount')}</th><th>${this.t('th_profit')}</th></tr></thead><tbody>${sRows}</tbody></table></div>
                `;
            },
            
            // --- People & Banks ---
            renderPeople: async function(div, col, title) {
                div.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>${title}</h3><button onclick="app.addPerson('${col}')" class="btn btn-prim">+</button></div><div class="card"><table id="ptable"><thead><tr><th>${this.t('th_name')}</th><th>${this.t('th_note')}</th><th>${this.t('th_amount')}</th></tr></thead><tbody></tbody></table></div>`;
                const s = await db.collection(col).where('companyId','==',this.state.cid).get();
                let h=''; s.forEach(d => { const v=d.data(); h+=`<tr><td>${v.name}</td><td>${v.phone}</td><td>${v.debt||v.balance||0}</td></tr>`; });
                document.querySelector('#ptable tbody').innerHTML = h;
            },
            addPerson: async function(col) {
                const n = prompt("Name:"); const p = prompt("Phone:");
                if(n) await db.collection(col).add({companyId:this.state.cid, name:n, phone:p, debt:0});
                this.nav(col);
            },
            renderBanks: async function(div) {
                 div.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>${this.t('banks')}</h3><button onclick="app.addBank()" class="btn btn-prim">+</button></div><div class="card"><table id="btable"><thead><tr><th>${this.t('th_name')}</th><th>${this.t('th_amount')}</th></tr></thead><tbody></tbody></table></div>`;
                 const s = await db.collection('banks').where('companyId','==',this.state.cid).get();
                 let h=''; s.forEach(d => { const v=d.data(); h+=`<tr><td>${v.name}</td><td>${v.balance}</td></tr>`; });
                 document.querySelector('#btable tbody').innerHTML = h;
            },
            addBank: async function() {
                const n = prompt("Bank Name:"); const b = Number(prompt("Balance:"));
                if(n) await db.collection('banks').add({companyId:this.state.cid, name:n, balance:b});
                this.nav('banks');
            },
            renderRevenue: async function(div) { this.listGeneric(div, 'revenue'); },
            
             add: async function(t) {
                if(t==='products') {
                    const n=prompt("Name"), b=Number(prompt("Buy")), s=Number(prompt("Sell")), q=Number(prompt("Qty"));
                    if(n&&b) { await db.collection('products').add({companyId:this.state.cid, name:n, buyPrice:b, sellPrice:s, stock:q}); this.nav('inventory'); }
                } else {
                    const v1=prompt("Name"), v3=Number(prompt("Amount"));
                    if(v1&&v3) { await db.collection(t).add({companyId:this.state.cid, val1:v1, val3:v3, createdAt:new Date().toISOString()}); this.nav(t); }
                }
            },
            del: async function(id,c) { if(confirm('?')) { await db.collection(c).doc(id).delete(); this.nav(this.state.currentView); } },
            toggleMenu: function() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('show'); }
        };
        
        window.onload = function() { app.init(); };
    </script>
</body>
</html>