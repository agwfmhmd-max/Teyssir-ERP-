<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ERP System - MDA Mobile</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MDA ERP">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135679.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3135/3135679.png">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            --primary: #1e3a8a; --secondary: #10b981; --danger: #ef4444; 
            --bg: #f4f7fa; --sidebar-w: 260px; --header-h: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: #333; overflow-x: hidden; }

        /* --- Language Button --- */
        .lang-float {
            position: fixed; top: 10px; z-index: 2000;
            background: white; border: 1px solid #ccc; padding: 5px 12px;
            border-radius: 20px; font-weight: bold; font-size: 14px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        html[dir="rtl"] .lang-float { left: 15px; }
        html[dir="ltr"] .lang-float { right: 15px; }

        /* --- Auth Screen --- */
        .auth-wrap {
            display: flex; min-height: 100vh; justify-content: center; align-items: center;
            background: linear-gradient(135deg, #1e3a8a, #111827); padding: 20px;
        }
        .auth-card {
            background: white; width: 100%; max-width: 400px; padding: 30px 20px;
            border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .inp-group { margin-bottom: 15px; }
        .inp {
            width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px;
            font-size: 16px; font-family: inherit; outline: none; transition: 0.3s;
        }
        .inp:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,58,138,0.1); }
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-weight: bold; font-size: 16px; cursor: pointer; color: white; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-prim { background: var(--primary); }
        .btn-sec { background: var(--secondary); }
        .btn-dan { background: var(--danger); }

        .wa-link {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: #25D366; color: white; text-decoration: none; padding: 12px;
            border-radius: 50px; font-weight: bold; margin-top: 15px;
        }

        /* --- Dashboard Layout --- */
        .app-container { display: none; flex-direction: column; min-height: 100vh; }
        
        .top-header {
            height: var(--header-h); background: white; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            position: sticky; top: 0; z-index: 1000;
        }
        .menu-btn { font-size: 24px; cursor: pointer; color: var(--primary); padding: 5px; }

        .sidebar {
            position: fixed; top: 0; bottom: 0; width: var(--sidebar-width); background: white;
            z-index: 1500; width: 280px; padding-top: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        html[dir="rtl"] .sidebar { right: 0; transform: translateX(100%); }
        html[dir="rtl"] .sidebar.open { transform: translateX(0); }
        
        html[dir="ltr"] .sidebar { left: 0; transform: translateX(-100%); }
        html[dir="ltr"] .sidebar.open { transform: translateX(0); }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1400; display: none;
        }
        .sidebar-overlay.show { display: block; }

        .nav-item {
            padding: 15px 20px; display: flex; align-items: center; gap: 15px;
            color: #555; font-weight: 500; cursor: pointer; border-bottom: 1px solid #f9f9f9;
        }
        .nav-item.active { background: #eff6ff; color: var(--primary); }
        
        .main-content { flex: 1; padding: 15px; overflow-y: auto; }
        
        .grid-responsive { display: grid; gap: 15px; }
        @media (min-width: 768px) {
            .grid-responsive { grid-template-columns: 2fr 1fr; }
            .sidebar { position: fixed; top: var(--header-h); bottom: 0; width: 250px; transform: none !important; box-shadow: none; border-inline-end: 1px solid #eee; z-index: 900; }
            html[dir="rtl"] .main-content { margin-right: 250px; }
            html[dir="ltr"] .main-content { margin-left: 250px; }
            .menu-btn { display: none; }
            .sidebar-overlay { display: none !important; }
        }

        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: start; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f8f9fa; white-space: nowrap; }

        .print-box { display: none; }
        @media print {
            .app-container, .auth-wrap, .lang-float { display: none !important; }
            .print-box { display: block !important; position: absolute; top:0; left:0; width:100%; background:white; }
        }
        .hidden { display: none !important; }
        
        #installBtn { 
            display: none; width: 100%; background: #333; color: white; margin-bottom: 15px; 
            padding: 10px; border-radius: 8px; text-align: center; cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Language Toggle -->
    <button onclick="app.toggleLang()" class="lang-float" id="langBtn">Fran√ßais</button>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-wrap">
        <div class="auth-card">
            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135679.png" alt="Icon" style="width:60px; margin-bottom:10px;">
            <h2 style="color:var(--primary); margin-top:0;" id="t_title">ERP System</h2>
            
            <div id="installBtn" onclick="app.installPWA()">üì≤ ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ / Install App</div>

            <form onsubmit="app.login(event)">
                <input id="logName" class="inp inp-group" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ©" required>
                <input id="logPhone" type="tel" class="inp inp-group" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ" required>
                <input id="logCode" type="password" class="inp inp-group" placeholder="ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ" required>
                <button type="submit" id="logBtn" class="btn btn-prim">ÿØÿÆŸàŸÑ</button>
            </form>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <p style="margin:0 0 10px; color:#666; font-size:0.9em;" id="t_getcode">ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ±ŸÖÿ≤:</p>
                <a href="https://wa.me/22220479962" class="wa-link">
                    <i class="fa-brands fa-whatsapp" style="font-size:1.2em"></i> 
                    <span id="t_contact">ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑŸÖÿ∑Ÿàÿ±</span>
                </a>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="appScreen" class="app-container">
        <div class="sidebar-overlay" onclick="app.toggleMenu()"></div>

        <!-- Header -->
        <header class="top-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="menu-btn" onclick="app.toggleMenu()"><i class="fa-solid fa-bars"></i></div>
                <div>
                    <div id="h_name" style="font-weight:bold; font-size:16px;"></div>
                    <div id="h_phone" style="font-size:12px; color:#666;"></div>
                </div>
            </div>
            <button onclick="location.reload()" class="btn btn-dan" style="width:auto; padding:8px 15px; font-size:14px;" id="t_logout">ÿÆÿ±Ÿàÿ¨</button>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div style="padding: 0 20px 20px; text-align:center;">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135679.png" style="width:40px;">
                <h3 style="color:var(--primary); margin:10px 0 0;">ERP MENU</h3>
            </div>
            <div class="nav-item active" onclick="app.nav('home')"><i class="fa-solid fa-home"></i> <span data-key="home">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span></div>
            <div class="nav-item" onclick="app.nav('pos')"><i class="fa-solid fa-cart-plus"></i> <span data-key="pos">ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ</span></div>
            <div class="nav-item" onclick="app.nav('invoices')"><i class="fa-solid fa-file-invoice"></i> <span data-key="inv">ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</span></div>
            <div class="nav-item" onclick="app.nav('inventory')"><i class="fa-solid fa-boxes"></i> <span data-key="stock">ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</span></div>
            <div class="nav-item" onclick="app.nav('expenses')"><i class="fa-solid fa-wallet"></i> <span data-key="exp">ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™</span></div>
            <div class="nav-item" onclick="app.nav('salaries')"><i class="fa-solid fa-users"></i> <span data-key="sal">ÿßŸÑÿ±Ÿàÿßÿ™ÿ®</span></div>
            <div class="nav-item" onclick="app.nav('reports')"><i class="fa-solid fa-chart-pie"></i> <span data-key="rep">ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±</span></div>
            <div id="adminLink" class="nav-item hidden" onclick="app.nav('admin')" style="color:red;"><i class="fa-solid fa-lock"></i> Admin</div>
        </aside>

        <!-- Content -->
        <main id="workspace" class="main-content"></main>
    </div>

    <!-- Print -->
    <div id="printArea" class="print-box"></div>

    <script>
        // PWA Registration
        let deferredPrompt;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });

        const firebaseConfig = {
            apiKey: "AIzaSyA6glwj94Onm0r6gRtxtoyqEISpPChDcHo",
            authDomain: "comptabilite-e35ed.firebaseapp.com",
            projectId: "comptabilite-e35ed",
            storageBucket: "comptabilite-e35ed.firebasestorage.app",
            messagingSenderId: "59372022194",
            appId: "1:59372022194:web:22b9f70c41b1479835dcab",
            measurementId: "G-EEDNJXLSN6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const dict = {
            ar: {
                title: "ŸÜÿ∏ÿßŸÖ ERP - ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ©", comp:"ÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿ±ŸÉÿ©", phone:"ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ", code:"ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ",
                btn:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ", wait:"ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...", get:"ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ:", cont:"ÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑŸÖÿ∑Ÿàÿ± (Ÿàÿßÿ™ÿ≥ÿßÿ®)",
                home:"ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©", pos:"ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®Ÿäÿπ", inv:"ÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±", stock:"ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ",
                exp:"ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™", sal:"ÿßŸÑÿ±Ÿàÿßÿ™ÿ®", rep:"ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿßŸÑŸäÿ©", logout:"ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                p_sel:"-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ --", p_pr:"ÿßŸÑÿ≥ÿπÿ±", p_qt:"ÿßŸÑÿπÿØÿØ", p_add:"ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©",
                p_cl:"ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ", p_save:"ÿ≠ŸÅÿ∏ Ÿàÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©", p_tot:"ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
                tbl_prod:"ÿßŸÑŸÖŸÜÿ™ÿ¨", tbl_qty:"ÿßŸÑŸÉŸÖŸäÿ©", tbl_tot:"ÿßŸÑŸÖÿ¨ŸÖŸàÿπ", tbl_act:"ÿ≠ÿ∞ŸÅ",
                th_date:"ÿßŸÑÿ™ÿßÿ±ŸäÿÆ", th_client:"ÿßŸÑÿπŸÖŸäŸÑ", th_amount:"ÿßŸÑŸÖÿ®ŸÑÿ∫", th_print:"ÿ∑ÿ®ÿßÿπÿ©",
                th_name:"ÿßŸÑÿßÿ≥ŸÖ", th_buy:"ÿ¥ÿ±ÿßÿ°", th_sell:"ÿ®Ÿäÿπ", th_stock:"ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ", th_del:"ÿ≠ÿ∞ŸÅ", th_edit:"ÿ™ÿπÿØŸäŸÑ",
                th_item:"ÿßŸÑÿ®ŸÜÿØ", th_note:"ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™", th_cost:"ÿßŸÑÿ™ŸÉŸÑŸÅÿ©", th_emp:"ÿßŸÑŸÖŸàÿ∏ŸÅ", th_job:"ÿßŸÑŸàÿ∏ŸäŸÅÿ©", th_sal:"ÿßŸÑÿ±ÿßÿ™ÿ®",
                income:"ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™", expense:"ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™", profit:"ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠",
                err_login:"ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©", err_sus:"Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿπÿ∑ŸÑ ÿ≠ÿßŸÑŸäÿßŸã",
                empty:"ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©", max_qty:"ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÅŸÇÿ∑: ",
                prompt_name:"ÿßŸÑÿßÿ≥ŸÖ / ÿßŸÑÿ®ŸäÿßŸÜ", prompt_buy:"ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°", prompt_sell:"ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ", prompt_qty:"ÿßŸÑŸÉŸÖŸäÿ©",
                prompt_note:"ŸÖŸÑÿßÿ≠ÿ∏ÿ©", prompt_amount:"ÿßŸÑŸÖÿ®ŸÑÿ∫", confirm_del:"ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅÿü", sys_active:"ÿßŸÑŸÜÿ∏ÿßŸÖ ŸäÿπŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠",
                err_price_logic: "ÿÆÿ∑ÿ£: ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°",
                prompt_new_price: "ÿ£ÿØÿÆŸÑ ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ ÿßŸÑÿ¨ÿØŸäÿØ"
            },
            fr: {
                title: "Syst√®me ERP - √âdition Gold", comp:"Nom de Soci√©t√©", phone:"T√©l√©phone", code:"Code d'activation",
                btn:"Connexion", wait:"V√©rification...", get:"Pour obtenir le code:", cont:"Contacter le d√©veloppeur",
                home:"Accueil", pos:"Point de Vente", inv:"Factures", stock:"Stock",
                exp:"D√©penses", sal:"Salaires", rep:"Rapports", logout:"D√©connexion",
                p_sel:"-- Choisir Produit --", p_pr:"Prix", p_qt:"Qt√©", p_add:"Ajouter",
                p_cl:"Nom du Client", p_save:"Enregistrer & Imprimer", p_tot:"Total",
                tbl_prod:"Produit", tbl_qty:"Qt√©", tbl_tot:"Total", tbl_act:"Suppr",
                th_date:"Date", th_client:"Client", th_amount:"Montant", th_print:"Imprimer",
                th_name:"Nom", th_buy:"Achat", th_sell:"Vente", th_stock:"Stock", th_del:"Suppr", th_edit:"Modif",
                th_item:"Article", th_note:"Note", th_cost:"Co√ªt", th_emp:"Employ√©", th_job:"Fonction", th_sal:"Salaire",
                income:"Revenus (Ventes)", expense:"D√©penses Totales", profit:"B√©n√©fice Net",
                err_login:"Identifiants invalides", err_sus:"Compte suspendu",
                empty:"Panier vide", max_qty:"Max disponible: ",
                prompt_name:"Nom / Article", prompt_buy:"Prix d'achat", prompt_sell:"Prix de vente", prompt_qty:"Quantit√©",
                prompt_note:"Note", prompt_amount:"Montant", confirm_del:"Confirmer la suppression ?", sys_active:"Syst√®me Actif",
                err_price_logic: "Erreur: Le prix de vente doit √™tre sup√©rieur au prix d'achat",
                prompt_new_price: "Entrez le nouveau prix de vente"
            }
        };

        const app = {
            state: { cid:null, name:'', phone:'', admin:false, lang:'ar' },
            cart: [],

            installPWA: function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            document.getElementById('installBtn').style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                }
            },

            toggleLang: function() {
                this.state.lang = this.state.lang==='ar'?'fr':'ar';
                const l = this.state.lang;
                document.documentElement.dir = l==='ar'?'rtl':'ltr';
                document.getElementById('langBtn').innerText = l==='ar'?'Fran√ßais':'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©';
                const d = dict[l];
                document.getElementById('t_title').innerText = d.title;
                document.getElementById('logName').placeholder = d.comp;
                document.getElementById('logPhone').placeholder = d.phone;
                document.getElementById('logCode').placeholder = d.code;
                document.getElementById('logBtn').innerText = d.btn;
                document.getElementById('t_getcode').innerText = d.get;
                document.getElementById('t_contact').innerText = d.cont;
                document.getElementById('t_logout').innerText = d.logout;
                document.querySelectorAll('[data-key]').forEach(el => el.innerText = d[el.getAttribute('data-key')]);
                if(this.state.cid) this.nav(document.querySelector('.nav-item.active') ? document.querySelector('.nav-item.active').getAttribute('onclick').split("'")[1] : 'home');
            },

            t: function(k) { return dict[this.state.lang][k] || k; },

            toggleMenu: function() {
                document.getElementById('sidebar').classList.toggle('open');
                document.querySelector('.sidebar-overlay').classList.toggle('show');
            },

            login: async function(e) {
                e.preventDefault();
                const btn=document.getElementById('logBtn'); btn.innerText=this.t('wait'); btn.disabled=true;
                const n=document.getElementById('logName').value, p=document.getElementById('logPhone').value, c=document.getElementById('logCode').value;

                try {
                    if(p==='46154399' && c==='371915') { this.state.admin=true; this.state.cid='ADMIN'; this.start('Admin','46154399'); return; }
                    
                    const s = await db.collection('activation_codes').where('code','==',c).get();
                    if(s.empty) throw new Error(this.t('err_login'));
                    const d = s.docs[0].data();
                    if(d.status==='suspended') throw new Error(this.t('err_sus'));
                    if((d.targetPhone && d.targetPhone!==p) || (d.used && d.actualPhone!==p)) throw new Error(this.t('err_login'));

                    let cid=d.companyId;
                    if(!d.used) {
                        const r = await db.collection('companies').add({name:n, phone:p, code:c, createdAt:new Date().toISOString()});
                        cid=r.id;
                        await db.collection('activation_codes').doc(s.docs[0].id).update({used:true, companyId:cid, actualName:n, actualPhone:p, status:'active'});
                    }
                    this.state.cid=cid; this.state.name=n; this.state.phone=p;
                    this.start(n,p);
                } catch(er) { alert(er.message); btn.disabled=false; btn.innerText=this.t('btn'); }
            },

            start: function(n,p) {
                document.getElementById('authScreen').style.display='none';
                document.getElementById('appScreen').style.display='flex';
                document.getElementById('h_name').innerText=n;
                document.getElementById('h_phone').innerText=p;
                if(this.state.admin) document.getElementById('adminLink').classList.remove('hidden');
                this.nav('home');
            },

            nav: function(page) {
                document.getElementById('sidebar').classList.remove('open');
                document.querySelector('.sidebar-overlay').classList.remove('show');
                document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
                const activeEl = document.querySelector(`.nav-item[onclick="app.nav('${page}')"]`);
                if(activeEl) activeEl.classList.add('active');

                const ws = document.getElementById('workspace');
                ws.innerHTML = '<div style="padding:50px; text-align:center;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>';
                
                setTimeout(() => {
                    if(page==='home') this.home(ws);
                    else if(page==='pos') this.pos(ws);
                    else if(page==='invoices') this.list(ws, 'invoices');
                    else if(page==='inventory') this.list(ws, 'products');
                    else if(page==='expenses') this.list(ws, 'expenses');
                    else if(page==='salaries') this.list(ws, 'salaries');
                    else if(page==='reports') this.reports(ws);
                    else if(page==='admin') this.admin(ws);
                }, 50);
            },

            home: function(div) {
                div.innerHTML = `<div class="card" style="text-align:center; padding:40px;">
                    <img src="https://cdn-icons-png.flaticon.com/512/3135/3135679.png" style="width:80px; margin-bottom:15px;">
                    <h3>${this.state.name}</h3><p>${this.t('sys_active')}</p>
                </div>`;
            },

            pos: async function(div) {
                this.cart=[];
                const s = await db.collection('products').where('companyId','==',this.state.cid).get();
                let ops = `<option value="">${this.t('p_sel')}</option>`;
                s.forEach(d=>{ const p=d.data(); if(p.stock>0) ops+=`<option value="${d.id}" data-p="${p.sellPrice}" data-n="${p.name}" data-s="${p.stock}">${p.name} (${p.stock})</option>`; });

                div.innerHTML = `<div class="grid-responsive">
                    <div class="card">
                        <select id="pp" class="inp inp-group" onchange="app.pu()">${ops}</select>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input id="pr" class="inp" readonly placeholder="${this.t('p_pr')}">
                            <input id="pq" type="number" class="inp" value="1" placeholder="${this.t('p_qt')}">
                        </div>
                        <button onclick="app.pa()" class="btn btn-sec">${this.t('p_add')}</button>
                        <div class="table-scroll" style="margin-top:15px;">
                            <table id="ct"><thead><tr><th>${this.t('tbl_prod')}</th><th>${this.t('tbl_qty')}</th><th>${this.t('tbl_tot')}</th><th>X</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                    <div class="card" style="background:#fffbeb">
                        <input id="pc" class="inp inp-group" placeholder="${this.t('p_cl')}">
                        <h2 id="pt" style="text-align:center; margin:10px 0;">0 MRU</h2>
                        <button onclick="app.ps()" class="btn btn-prim">${this.t('p_save')}</button>
                    </div>
                </div>`;
            },
            pu: function() { const e=document.getElementById('pp'); document.getElementById('pr').value=e.options[e.selectedIndex].getAttribute('data-p'); },
            pa: function() {
                const e=document.getElementById('pp'), id=e.value; if(!id) return;
                const n=e.options[e.selectedIndex].getAttribute('data-n'), s=Number(e.options[e.selectedIndex].getAttribute('data-s'));
                const p=Number(document.getElementById('pr').value), q=Number(document.getElementById('pq').value);
                if(q>s) return alert(this.t('max_qty')+s);
                this.cart.push({id,n,p,q,t:p*q}); this.pr();
            },
            pr: function() {
                let h='',t=0; this.cart.forEach((i,x)=>{ t+=i.t; h+=`<tr><td>${i.n}</td><td>${i.q}</td><td>${i.t}</td><td onclick="app.cart.splice(${x},1);app.pr()" style="color:red">X</td></tr>`; });
                document.querySelector('#ct tbody').innerHTML=h; document.getElementById('pt').innerText=t.toLocaleString()+' MRU';
            },
            ps: async function() {
                if(!this.cart.length) return alert(this.t('empty'));
                const c=document.getElementById('pc').value||'Client', t=Number(document.getElementById('pt').innerText.replace(/[^0-9.]/g,''));
                try {
                    const r = await db.collection('invoices').add({companyId:this.state.cid, customer:c, items:this.cart, total:t, createdAt:new Date().toISOString()});
                    for(let i of this.cart) {
                        const ref = db.collection('products').doc(i.id);
                        await db.runTransaction(async tr=>{ const d=await tr.get(ref); tr.update(ref,{stock:d.data().stock-i.q}); });
                    }
                    this.print(r.id,c,t,this.cart); this.nav('pos');
                } catch(e){alert(e.message)}
            },

            list: async function(div, type) {
                const titles = {invoices:this.t('inv'), products:this.t('stock'), expenses:this.t('exp'), salaries:this.t('sal')};
                div.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <h3>${titles[type]}</h3> 
                    ${type!=='invoices' ? `<button onclick="app.add('${type}')" class="btn btn-prim" style="width:auto; padding:8px 15px;">+</button>` : ''}
                </div>
                <div class="card"><div class="table-scroll"><table id="lst"><thead></thead><tbody><tr><td>Loading...</td></tr></tbody></table></div></div>`;
                
                const s = await db.collection(type).where('companyId','==',this.state.cid).get();
                let docs = s.docs.map(d=>({id:d.id,...d.data()}));
                if(type==='invoices') docs.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

                let h='', th='';
                if(type==='invoices') {
                    th=`<tr><th>${this.t('th_date')}</th><th>${this.t('th_client')}</th><th>${this.t('th_amount')}</th><th>${this.t('th_print')}</th></tr>`;
                    docs.forEach(d=>{
                        const str = encodeURIComponent(JSON.stringify(d.items));
                        h+=`<tr><td>${new Date(d.createdAt).toLocaleDateString()}</td><td>${d.customer}</td><td>${d.total}</td>
                        <td><button class="btn btn-sec" style="padding:5px 10px; font-size:12px;" onclick="app.reprint('${d.id}','${d.customer}',${d.total},'${str}')">${this.t('th_print')}</button></td></tr>`;
                    });
                } else if(type==='products') {
                    th=`<tr><th>${this.t('th_name')}</th><th>${this.t('th_buy')}</th><th>${this.t('th_sell')}</th><th>${this.t('th_stock')}</th><th>${this.t('th_edit')}</th><th>${this.t('th_del')}</th></tr>`;
                    docs.forEach(d=>h+=`<tr><td>${d.name}</td><td>${d.buyPrice}</td><td>${d.sellPrice}</td><td>${d.stock}</td>
                    <td><button onclick="app.editProd('${d.id}', ${d.buyPrice}, ${d.sellPrice})" style="border:none;background:none;font-size:1.2em;cursor:pointer">‚úé</button></td>
                    <td onclick="app.del('${d.id}','${type}')" style="color:red;cursor:pointer">X</td></tr>`);
                } else {
                    const h1 = type==='salaries' ? this.t('th_emp') : this.t('th_item');
                    const h2 = type==='salaries' ? this.t('th_job') : this.t('th_note');
                    const h3 = type==='salaries' ? this.t('th_sal') : this.t('th_cost');
                    th=`<tr><th>${h1}</th><th>${h2}</th><th>${h3}</th><th>${this.t('th_del')}</th></tr>`;
                    docs.forEach(d=>{
                        if(type==='expenses' && d.type==='purchase') return;
                        h+=`<tr><td>${d.val1}</td><td>${d.val2}</td><td>${d.val3}</td><td onclick="app.del('${d.id}','${type}')" style="color:red">X</td></tr>`;
                    });
                }
                document.querySelector('#lst thead').innerHTML=th; document.querySelector('#lst tbody').innerHTML=h||'<tr><td colspan="4">-</td></tr>';
            },

            add: async function(t) {
                if(t==='products') {
                    const n=prompt(this.t('prompt_name')), b=Number(prompt(this.t('prompt_buy'))), s=Number(prompt(this.t('prompt_sell'))), q=Number(prompt(this.t('prompt_qty')));
                    if(n&&b) {
                        if (s <= b) { return alert(this.t('err_price_logic')); }
                        await db.collection('products').add({companyId:this.state.cid, name:n, buyPrice:b, sellPrice:s, stock:q, createdAt:new Date().toISOString()});
                        await db.collection('expenses').add({companyId:this.state.cid, type:'purchase', val1:'Buy '+n, val2:'Stock', val3:b*q, createdAt:new Date().toISOString()});
                        this.nav('inventory');
                    }
                } else {
                    const v1=prompt(this.t('prompt_name')), v2=prompt(this.t('prompt_note')), v3=Number(prompt(this.t('prompt_amount')));
                    if(v1&&v3) {
                        await db.collection(t).add({companyId:this.state.cid, val1:v1, val2:v2, val3:v3, createdAt:new Date().toISOString()});
                        this.nav(t);
                    }
                }
            },
            
            editProd: async function(id, buy, oldSell) {
                let newSell = prompt(this.t('prompt_new_price'), oldSell);
                if (!newSell) return;
                newSell = Number(newSell);
                
                // Strict Logic: New Sell Price MUST be > Buy Price
                if (newSell <= buy) {
                    alert(this.t('err_price_logic'));
                    return;
                }
                
                await db.collection('products').doc(id).update({sellPrice: newSell});
                this.nav('inventory');
            },

            del: async function(id,c) { if(confirm(this.t('confirm_del'))) { await db.collection(c).doc(id).delete(); this.nav(c==='products'?'inventory':c); } },

            reports: async function(div) {
                div.innerHTML='Loading...';
                const [i,e,s] = await Promise.all([
                    db.collection('invoices').where('companyId','==',this.state.cid).get(),
                    db.collection('expenses').where('companyId','==',this.state.cid).get(),
                    db.collection('salaries').where('companyId','==',this.state.cid).get()
                ]);
                let inc=0, out=0;
                i.forEach(d=>inc+=d.data().total);
                e.forEach(d=>out+=Number(d.data().val3));
                s.forEach(d=>out+=Number(d.data().val3));
                
                div.innerHTML = `<div class="grid-responsive">
                    <div class="card"><h3>${this.t('income')}</h3><h2 style="color:green">${inc.toLocaleString()}</h2></div>
                    <div class="card"><h3>${this.t('expense')}</h3><h2 style="color:red">${out.toLocaleString()}</h2></div>
                </div>
                <div class="card" style="text-align:center"><h3>${this.t('profit')}</h3><h1>${(inc-out).toLocaleString()} MRU</h1></div>`;
            },

            reprint: function(id, c, t, itemsStr) {
                const items = JSON.parse(decodeURIComponent(itemsStr));
                this.print(id,c,t,items);
            },
            print: function(id, c, t, items) {
                const dir = this.state.lang==='ar'?'rtl':'ltr';
                const d = new Date().toLocaleDateString();
                const headers = `<tr><th style="border:1px solid #000">${this.t('tbl_prod')}</th><th style="border:1px solid #000">${this.t('tbl_qty')}</th><th style="border:1px solid #000">${this.t('tbl_tot')}</th></tr>`;
                let rows = items.map(i=>`<tr><td style="border:1px solid #000">${i.n}</td><td style="border:1px solid #000">${i.q}</td><td style="border:1px solid #000">${i.t}</td></tr>`).join('');
                document.getElementById('printArea').innerHTML = `
                    <div style="padding:20px; direction:${dir}; font-family:'Tajawal'">
                        <center><h2>${this.state.name}</h2><p>${this.state.phone}</p></center>
                        <hr>
                        <p>INV: ${id.substring(0,5)} | ${d} <br> ${this.t('th_client')}: ${c}</p>
                        <table style="width:100%; border-collapse:collapse; text-align:center;">
                            ${headers}${rows}
                        </table>
                        <h3>${this.t('p_tot')}: ${t.toLocaleString()} MRU</h3>
                        <center><small>MDA ERP System</small></center>
                    </div>
                `;
                window.print();
            },

            admin: async function(div) {
                div.innerHTML = `<div class="card"><input id="an" class="inp inp-group" placeholder="Name"><input id="ap" class="inp inp-group" placeholder="Phone"><button onclick="app.gen()" class="btn btn-prim">Generate</button></div><div class="card"><div class="table-scroll"><table id="at"><thead></thead><tbody></tbody></table></div></div>`;
                const s = await db.collection('activation_codes').orderBy('createdAt','desc').limit(20).get();
                let h='<tr><th>Code</th><th>Client</th><th>St</th><th>Act</th></tr>', b='';
                s.forEach(d=>{
                    const v=d.data();
                    b+=`<tr><td>${v.code}</td><td>${v.targetCompanyName||v.actualName}</td><td>${v.status}</td>
                    <td><button onclick="app.tst('${d.id}','${v.status}')">${v.status==='active'?'Stop':'Start'}</button></td></tr>`;
                });
                document.querySelector('#at thead').innerHTML=h; document.querySelector('#at tbody').innerHTML=b;
            },
            gen: async function() {
                const n=document.getElementById('an').value, p=document.getElementById('ap').value;
                if(n&&p) { await db.collection('activation_codes').add({code:Math.floor(100000+Math.random()*900000).toString(), targetCompanyName:n, targetPhone:p, status:'active', used:false, createdAt:new Date().toISOString()}); this.nav('admin'); }
            },
            tst: async function(id,st) { await db.collection('activation_codes').doc(id).update({status:st==='active'?'suspended':'active'}); this.nav('admin'); }
        };
    </script>
</body>
</html>