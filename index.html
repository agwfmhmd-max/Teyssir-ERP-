<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teyssir ERP</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00897b">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">

    <!-- Firebase (Ù†Ø³Ø® Ù…Ø³ØªÙ‚Ø±Ø© ÙˆØ³Ø±ÙŠØ¹Ø©) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS Clean & Professional */
        :root { 
            --primary: #00897b; --accent: #263238; --bg: #f8f9fa; --white: #ffffff;
            --text: #212121; --border: #e0e0e0; --danger: #d32f2f; --success: #388e3c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* Loader */
        #mainLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.3s; }
        .spinner { width: 45px; height: 45px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Layout */
        .app-container { display: none; flex-direction: column; min-height: 100vh; }
        .top-header { height: 60px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        
        .sidebar { position: fixed; top: 0; bottom: 0; width: 260px; background: var(--white); z-index: 1500; padding-top: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.1); transition: transform 0.3s ease; border-inline-end: 1px solid var(--border); }
        html[dir="rtl"] .sidebar { right: 0; transform: translateX(100%); } html[dir="rtl"] .sidebar.open { transform: translateX(0); }
        html[dir="ltr"] .sidebar { left: 0; transform: translateX(-100%); } html[dir="ltr"] .sidebar.open { transform: translateX(0); }
        
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1400; display: none; }
        .sidebar-overlay.show { display: block; }

        .nav-item { padding: 14px 20px; display: flex; align-items: center; gap: 10px; color: #555; font-weight: 500; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; border-right: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #e0f2f1; color: var(--primary); }
        html[dir="rtl"] .nav-item.active { border-right-color: var(--primary); } html[dir="ltr"] .nav-item.active { border-left-color: var(--primary); }

        .main-content { flex: 1; padding: 20px; overflow-y: auto; }

        /* Auth */
        .auth-wrap { display: none; min-height: 100vh; justify-content: center; align-items: center; background: #e0f2f1; padding: 20px; }
        .auth-card { background: var(--white); width: 100%; max-width: 380px; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .inp { width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 16px; margin-bottom: 15px; outline: none; background: #fafafa; }
        .inp:focus { border-color: var(--primary); background: #fff; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-prim { background: var(--primary); color: white; }
        .btn-sec { background: var(--accent); color: white; }
        .btn-dan { background: var(--danger); color: white; }

        /* Admin Link Visibility */
        .admin-only { display: none !important; }
        .admin-visible { display: flex !important; color: var(--danger) !important; background: #ffebee !important; }

        /* Cards & Grid */
        .card { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid var(--border); }
        .home-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .home-card { background: white; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 120px; }
        .home-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .home-icon { font-size: 32px; margin-bottom: 10px; color: var(--primary); }
        
        /* Lang Button */
        .lang-btn { position: fixed; top: 15px; z-index: 20000; width: 40px; height: 40px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        html[dir="rtl"] .lang-btn { left: 20px; } html[dir="ltr"] .lang-btn { right: 20px; }

        /* Tables */
        .table-scroll { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; text-align: start; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f5f5f5; color: var(--primary); white-space: nowrap; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 15px; animation: pop 0.3s; }
        @keyframes pop { from{transform:scale(0.9)} to{transform:scale(1)} }

        /* Helpers */
        .hidden { display: none; }
        #installBtn { display: none; width: 100%; background: var(--accent); color: white; margin-bottom: 15px; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; }
    </style>
</head>
<body>

    <div id="mainLoader"><div class="spinner"></div></div>
    
    <button onclick="app.toggleLang()" class="lang-btn"><i class="fa-solid fa-language"></i></button>

    <!-- Welcome Modal -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <img src="logo.png" style="width:70px; margin-bottom:15px;">
            <h3 style="color:var(--primary);">Teyssir ERP</h3>
            <p style="color:#666; margin-bottom:20px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³ÙŠÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„.<br>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„.</p>
            <a href="https://wa.me/22220479962" class="btn btn-sec" style="text-decoration:none; justify-content:center; margin-bottom:10px;">
                <i class="fa-brands fa-whatsapp"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
            </a>
            <button onclick="app.closeWelcome()" class="btn btn-prim" style="width:100%">ÙÙ‡Ù…Øª</button>
        </div>
    </div>

    <!-- Auth -->
    <div id="authScreen" class="auth-wrap">
        <div class="auth-card">
            <img src="logo.png" style="width:80px; margin-bottom:15px;">
            <h3 style="color:var(--primary); margin:0 0 20px;" data-key="title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <div id="installBtn" onclick="app.installPWA()">ğŸ“² <span data-key="t_install">ØªØ«Ø¨ÙŠØª</span></div>
            <form onsubmit="app.login(event)">
                <input id="logName" class="inp" data-ph="comp" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
                <input id="logPhone" type="tel" class="inp" data-ph="phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" required>
                <input id="logCode" type="password" class="inp" data-ph="code" placeholder="Ø§Ù„Ø±Ù…Ø²" required>
                <button type="submit" id="logBtn" class="btn btn-prim" style="width:100%" data-key="btn">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <!-- App -->
    <div id="appScreen" class="app-container">
        <div class="sidebar-overlay" onclick="app.toggleMenu()"></div>
        <header class="top-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fa-solid fa-bars" onclick="app.toggleMenu()" style="font-size:22px; color:var(--primary); cursor:pointer;"></i>
                <h3 style="margin:0; font-size:16px; color:var(--primary);">Teyssir ERP</h3>
            </div>
            <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø®ÙÙŠ -->
        </header>
        
        <aside class="sidebar" id="sidebar">
            <div style="padding:20px; text-align:center; border-bottom:1px solid #eee;">
                <img src="logo.png" style="width:60px;">
                <div id="userInfo" style="font-size:12px; color:#777; margin-top:5px;"></div>
            </div>
            <div style="padding:10px 0; overflow-y:auto; flex:1;">
                <div class="nav-item" onclick="app.nav('home')"><i class="fa-solid fa-home"></i> <span data-key="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
                <div class="nav-item" onclick="app.nav('pos')"><i class="fa-solid fa-cart-shopping"></i> <span data-key="pos">Ø§Ù„Ø¨ÙŠØ¹</span></div>
                <div class="nav-item" onclick="app.nav('customers')"><i class="fa-solid fa-users"></i> <span data-key="customers">Ø§Ù„Ø²Ø¨Ù†Ø§Ø¡</span></div>
                <div class="nav-item" onclick="app.nav('suppliers')"><i class="fa-solid fa-truck"></i> <span data-key="suppliers">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</span></div>
                <div class="nav-item" onclick="app.nav('banks')"><i class="fa-solid fa-building-columns"></i> <span data-key="banks">Ø§Ù„Ø¨Ù†ÙˆÙƒ</span></div>
                <div class="nav-item" onclick="app.nav('invoices')"><i class="fa-solid fa-file-invoice"></i> <span data-key="inv">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span></div>
                <div class="nav-item" onclick="app.nav('inventory')"><i class="fa-solid fa-boxes"></i> <span data-key="stock">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span></div>
                <div class="nav-item" onclick="app.nav('expenses')"><i class="fa-solid fa-wallet"></i> <span data-key="exp">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span></div>
                <div class="nav-item" onclick="app.nav('reports')"><i class="fa-solid fa-chart-pie"></i> <span data-key="rep">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></div>
                
                <!-- Ø²Ø± Ø§Ù„Ù…Ø´Ø±Ù Ù…Ø¹ ÙØ¦Ø© Ø®Ø§ØµØ© Ù„Ù„ØªØ­ÙƒÙ… -->
                <div id="adminLink" class="nav-item admin-only" onclick="app.nav('admin')">
                    <i class="fa-solid fa-lock"></i> <span>Admin</span>
                </div>
                
                <div class="nav-item" onclick="app.logout()" style="color:var(--danger); margin-top:20px;">
                    <i class="fa-solid fa-right-from-bracket"></i> <span data-key="logout">Ø®Ø±ÙˆØ¬</span>
                </div>
            </div>
        </aside>
        
        <main id="workspace" class="main-content"></main>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6glwj94Onm0r6gRtxtoyqEISpPChDcHo",
            authDomain: "comptabilite-e35ed.firebaseapp.com",
            projectId: "comptabilite-e35ed",
            storageBucket: "comptabilite-e35ed.firebasestorage.app",
            messagingSenderId: "59372022194",
            appId: "1:59372022194:web:22b9f70c41b1479835dcab",
            measurementId: "G-EEDNJXLSN6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø©
        db.enablePersistence().catch(err => console.log("Persistence error", err));

        // --- 2. Dictionary ---
        const dict = {
            ar: {
                title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", comp:"Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©", phone:"Ø§Ù„Ù‡Ø§ØªÙ", code:"Ø§Ù„Ø±Ù…Ø²", btn:"Ø¯Ø®ÙˆÙ„",
                home:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", pos:"Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹", inv:"Ø§Ù„ÙÙˆØ§ØªÙŠØ±", stock:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", exp:"Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª", rep:"Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±",
                customers:"Ø§Ù„Ø²Ø¨Ù†Ø§Ø¡", suppliers:"Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", banks:"Ø§Ù„Ø¨Ù†ÙˆÙƒ", logout:"Ø®Ø±ÙˆØ¬",
                t_install: "ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", w_title: "Ù…Ø±Ø­Ø¨Ø§Ù‹", w_btn: "ÙÙ‡Ù…Øª", cont: "Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø·ÙˆØ±"
            },
            fr: {
                title: "Connexion", comp:"SociÃ©tÃ©", phone:"TÃ©l", code:"Code", btn:"Entrer",
                home:"Accueil", pos:"Vente", inv:"Factures", stock:"Stock", exp:"DÃ©penses", rep:"Rapports",
                customers:"Clients", suppliers:"Fournisseurs", banks:"Banques", logout:"DÃ©connexion",
                t_install: "Installer", w_title: "Bienvenue", w_btn: "Compris", cont: "Contacter Dev"
            }
        };

        // --- 3. App Logic ---
        const app = {
            state: { cid:null, name:'', phone:'', admin:false, lang:'ar', currentView:'home' },

            init: function() {
                // Install Prompt
                window.addEventListener('beforeinstallprompt', (e) => { 
                    e.preventDefault(); 
                    document.getElementById('installBtn').style.display = 'block'; 
                    app.deferredPrompt = e; 
                });

                // Welcome Screen Check
                if (!localStorage.getItem('welcomeSeen')) {
                    document.getElementById('welcomeModal').style.display = 'flex';
                }

                // Session Check
                const session = localStorage.getItem('mda_session');
                if(session) {
                    const s = JSON.parse(session);
                    // Check if Admin Login immediately
                    if(s.admin) {
                        this.state = {...s, admin:true};
                        this.start();
                    } else {
                        // Check normal user
                        this.state = s;
                        this.start();
                        // Background validation (optional for speed)
                    }
                } else {
                    document.getElementById('mainLoader').style.display = 'none';
                    document.getElementById('authScreen').style.display = 'flex';
                }
            },
            
            installPWA: function() {
                if (app.deferredPrompt) {
                    app.deferredPrompt.prompt();
                    app.deferredPrompt = null;
                }
            },

            closeWelcome: function() {
                document.getElementById('welcomeModal').style.display = 'none';
                localStorage.setItem('welcomeSeen', 'true');
            },

            toggleLang: function() {
                this.state.lang = this.state.lang==='ar'?'fr':'ar';
                document.documentElement.dir = this.state.lang==='ar'?'rtl':'ltr';
                // Translate
                const d = dict[this.state.lang];
                document.querySelectorAll('[data-key]').forEach(el => el.innerText = d[el.getAttribute('data-key')] || el.innerText);
                document.querySelectorAll('[data-ph]').forEach(el => el.placeholder = d[el.getAttribute('data-ph')] || el.placeholder);
                // Refresh View
                if(this.state.cid) this.nav(this.state.currentView);
            },
            t: function(k) { return dict[this.state.lang][k] || k; },

            login: async function(e) {
                e.preventDefault();
                const n=document.getElementById('logName').value;
                const p=document.getElementById('logPhone').value;
                const c=document.getElementById('logCode').value;

                // --- Admin Login (Hardcoded for Speed) ---
                if(p === '46154399' && c === '371915') {
                    const s = {cid:'ADMIN', name:'Admin', phone:p, admin:true};
                    localStorage.setItem('mda_session', JSON.stringify(s));
                    this.state = s;
                    this.start();
                    return;
                }

                // --- Normal Login ---
                document.getElementById('mainLoader').style.display = 'flex';
                try {
                    const q = await db.collection('activation_codes').where('code','==',c).get();
                    if(q.empty) throw new Error("Code Incorrect");
                    const d = q.docs[0].data();
                    
                    if(d.status === 'suspended') throw new Error("Compte Suspendu");
                    
                    let cid = d.companyId;
                    if(!d.used) {
                        const r = await db.collection('companies').add({name:n, phone:p, code:c, date:new Date().toISOString()});
                        cid = r.id;
                        await db.collection('activation_codes').doc(q.docs[0].id).update({used:true, companyId:cid, actualName:n, actualPhone:p, status:'active'});
                    }

                    const s = {cid, name:n, phone:p, admin:false};
                    localStorage.setItem('mda_session', JSON.stringify(s));
                    this.state = s;
                    this.start();

                } catch(err) {
                    alert(err.message);
                    document.getElementById('mainLoader').style.display = 'none';
                }
            },

            start: function() {
                document.getElementById('mainLoader').style.display = 'none';
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'flex';
                
                // Show/Hide Admin Button based on State
                const adminLink = document.getElementById('adminLink');
                if(this.state.admin) {
                    adminLink.classList.remove('admin-only');
                    adminLink.classList.add('admin-visible');
                } else {
                    adminLink.classList.remove('admin-visible');
                    adminLink.classList.add('admin-only');
                }

                document.getElementById('userInfo').innerText = this.state.name;
                this.nav('home');
            },

            logout: function() {
                localStorage.removeItem('mda_session');
                location.reload();
            },
            
            toggleMenu: function() {
                document.getElementById('sidebar').classList.toggle('open');
                document.querySelector('.sidebar-overlay').classList.toggle('show');
            },

            nav: function(page) {
                this.state.currentView = page;
                document.getElementById('sidebar').classList.remove('open');
                document.querySelector('.sidebar-overlay').classList.remove('show');
                const ws = document.getElementById('workspace');
                ws.innerHTML = '';
                
                if(page === 'home') this.renderHome(ws);
                else if(page === 'admin') this.renderAdmin(ws);
                else ws.innerHTML = `<h3 style="text-align:center; margin-top:50px;">${this.t(page)}</h3>`; // Placeholder
            },

            renderHome: function(div) {
                const items = [
                    {k:'pos', i:'fa-cart-shopping'}, {k:'inv', i:'fa-file-invoice'}, 
                    {k:'customers', i:'fa-users'}, {k:'suppliers', i:'fa-truck'},
                    {k:'banks', i:'fa-building-columns'}, {k:'stock', i:'fa-boxes-stacked'}
                ];
                let h = '<div class="home-grid">';
                items.forEach(it => {
                    h += `<div class="home-card" onclick="app.nav('${it.k}')">
                        <div class="home-icon"><i class="fa-solid ${it.i}"></i></div>
                        <div class="home-label">${this.t(it.k)}</div>
                    </div>`;
                });
                div.innerHTML = h + '</div>';
            },

            // --- Admin Panel (Simplified) ---
            renderAdmin: async function(div) {
                if(!this.state.admin) return;
                div.innerHTML = `
                    <div class="card">
                        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ù…ÙˆØ²</h3>
                        <button onclick="app.gen()" class="btn btn-prim" style="margin-bottom:10px;">ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯</button>
                        <div class="table-scroll"><table id="admTable"><thead><tr><th>Code</th><th>Name</th><th>Status</th><th>Act</th></tr></thead><tbody></tbody></table></div>
                    </div>`;
                this.loadCodes();
            },
            loadCodes: async function() {
                const s = await db.collection('activation_codes').orderBy('createdAt','desc').limit(20).get();
                let h='';
                s.forEach(d => {
                    const v = d.data();
                    h += `<tr><td>${v.code}</td><td>${v.actualName||'-'}</td><td>${v.status}</td><td><button onclick="app.toggleStat('${d.id}','${v.status}')" class="btn btn-sec" style="padding:5px 10px;font-size:12px">Toggle</button></td></tr>`;
                });
                document.querySelector('#admTable tbody').innerHTML = h;
            },
            gen: async function() {
                const c = Math.floor(100000+Math.random()*900000).toString();
                await db.collection('activation_codes').add({code:c, status:'active', used:false, createdAt:new Date().toISOString()});
                this.loadCodes();
            },
            toggleStat: async function(id, st) {
                await db.collection('activation_codes').doc(id).update({status:st==='active'?'suspended':'active'});
                this.loadCodes();
            }
        };

        window.onload = function() { app.init(); };
    </script>
</body>
</html>